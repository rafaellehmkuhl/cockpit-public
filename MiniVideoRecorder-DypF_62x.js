import{c as Z,P as K,J as ee,Q as te,R as ae,S as se,r as p,U as oe,V as ne,e as ie,k as M,w as S,o as re,W as le,X as de,Y as ue,Z as ce,D as ve,l as r,m as u,n as c,x as T,s as n,G as v,$ as y,a0 as k,a1 as F,F as U,t as E,H as L,v as z,a2 as me,a3 as ge,a4 as fe,a5 as pe,a6 as q,a7 as ye,a8 as xe,_ as we}from"./index-_zmxGxl2.js";const Se={key:1},he={class:"text-xs text-white select-none scroll-text"},be={key:3,class:"w-16 text-justify text-slate-100"},Ve={key:4,class:"w-16 text-justify text-slate-100"},ke={class:"flex justify-center w-6"},Me={class:"flex w-full justify-between items-center mt-4"},Fe={key:1,class:"w-5 h-5 ml-2 rounded-full bg-red"},Ce=Z({__name:"MiniVideoRecorder",props:{miniWidget:{}},setup(G){const{showDialog:x}=K(),C=ee(),m=te(),s=ae(),a=se(G).miniWidget,o=p(),{namessAvailableAbstractedStreams:b}=oe(s),R=p(),{isOutside:N}=ne(R),W=p(!1),w=p(!1),H=ie({interval:100}),g=p(),h=p(!1),I=p(0),i=M(()=>o.value?s.externalStreamId(o.value):void 0),O=()=>{C.videoLibraryVisibility=!0};S(()=>s.streamsCorrespondency,()=>g.value=void 0,{deep:!0}),re(async()=>{await V()}),le(async()=>{Object.keys(a.value.options).length===0&&(a.value.options={internalStreamName:void 0}),o.value=a.value.options.internalStreamName}),S(o,()=>{a.value.options.internalStreamName=o.value,g.value=void 0});const V=async()=>{const t=(await s.videoStoringDB.keys()).filter(l=>s.isVideoFilename(l)).length,e=Object.keys(s.keysFailedUnprocessedVideos).length;I.value=t+e};function _(t){if(o.value=t,o.value===void 0){x({message:"No stream selected.",variant:"error"});return}if(b.value.includes(o.value))return;const e="The selected stream is not available. Please check its source or select another stream.";throw x({message:e,variant:"error"}),new Error(e)}const Y=async()=>{if(f.value){i.value!==void 0&&s.stopRecording(i.value);return}if(o.value===void 0){m.miniWidgetManagerVars(a.value.hash).configMenuOpen=!0;return}D()},D=()=>{var t;if(i.value===void 0){x({title:"Cannot start recording.",message:"No stream selected.",variant:"error"});return}if(!((t=s.getStreamData(i.value))!=null&&t.connected)){x({title:"Cannot start recording.",message:"Stream is not connected.",variant:"error"});return}_(o.value),s.startRecording(i.value),m.miniWidgetManagerVars(a.value.hash).configMenuOpen=!1},f=M(()=>i.value===void 0?!1:s.isRecording(i.value)),J=M(()=>{var $,j,A,P;if(i.value===void 0)return"00:00:00";const t=($=s.getStreamData(i.value))==null?void 0:$.timeRecordingStart;if(t===void 0)return"00:00:00";const e=de({start:t,end:H.value}),l=((j=e.hours)==null?void 0:j.toFixed(0).length)===1?`0${e.hours}`:e.hours,d=((A=e.minutes)==null?void 0:A.toFixed(0).length)===1?`0${e.minutes}`:e.minutes,X=((P=e.seconds)==null?void 0:P.toFixed(0).length)===1?`0${e.seconds}`:e.seconds;return`${l}:${d}:${X}`}),Q=async t=>{_(t),g.value=void 0,w.value=!0;let e=0;const l=100,d=3e3;for(;w.value&&e<d;)w.value=g.value===void 0||!g.value.active,await xe(l),e+=l;if(w.value){x({message:"Could not load media stream.",variant:"error"});return}a.value.options.internalStreamName=t};let B;return m.isRealMiniWidget(a.value)&&(B=setInterval(()=>{if(a.value.options.internalStreamName===void 0&&!b.value.isEmpty()&&(a.value.options.internalStreamName=b.value[0],o.value=a.value.options.internalStreamName),i.value!==void 0){const t=s.getMediaStream(a.value.options.internalStreamName);ue(t,g.value)||(g.value=t)}},1e3)),ce(()=>clearInterval(B)),S(()=>s.areThereVideosProcessing,t=>{h.value=t,V()}),S(()=>s.keysFailedUnprocessedVideos,()=>V()),S(()=>W.value,async t=>{t===!1&&await V()}),S(f,()=>{if(!f.value){window.onbeforeunload=null;return}window.onbeforeunload=()=>(x({message:`
      You have a video recording ongoing.
      Remember to stop it before closing Cockpit, or the record will be lost.
    `,variant:"warning"}),"I hope the user does not click on the leave button.")}),(t,e)=>{const l=ve("FontAwesomeIcon");return r(),u(U,null,[c("div",{ref_key:"recorderWidget",ref:R,class:"flex justify-around px-2 py-1 text-center rounded-lg w-40 h-9 align-center bg-slate-800/60"},[h.value?(r(),u("div",Se,[v(F,{class:"w-6 h-6 animate-spin",color:"white"},{default:y(()=>e[4]||(e[4]=[k("mdi-loading")])),_:1})])):(r(),u("div",{key:0,class:T([{"blob red w-5 opacity-100 rounded-sm":f.value,"opacity-30 bg-red-400":n(N)&&!f.value},"w-6 transition-all duration-500 rounded-full aspect-square bg-red-lighten-1 hover:cursor-pointer opacity-70 hover:opacity-90"]),onClick:e[0]||(e[0]=d=>Y())},null,2)),!f.value&&!h.value?(r(),u(U,{key:2},[o.value?(r(),u("div",{key:0,class:"flex flex-col max-w-[50%] scroll-container transition-all border-blur cursor-pointer",onClick:e[1]||(e[1]=d=>n(m).miniWidgetManagerVars(n(a).hash).configMenuOpen=!0)},[c("div",he,E(o.value),1)])):(r(),L(l,{key:1,icon:"fa-solid fa-video",class:"h-6 text-slate-100"}))],64)):z("",!0),f.value&&!h.value?(r(),u("div",be,E(J.value),1)):h.value?(r(),u("div",Ve,e[5]||(e[5]=[c("div",{class:"text-xs text-center text-white select-none flex-nowrap"},"Processing video...",-1)]))):z("",!0),c("div",ke,[v(me,{vertical:"",class:"h-6 ml-1"}),v(ge,{color:"info",content:I.value,dot:n(N)||W.value,class:"cursor-pointer",onClick:O},{default:y(()=>[v(F,{class:"w-6 h-6 ml-1 text-slate-100",onClick:O},{default:y(()=>e[6]||(e[6]=[k(" mdi-video-box ")])),_:1})]),_:1},8,["content","dot"])])],512),v(ye,{modelValue:n(m).miniWidgetManagerVars(n(a).hash).configMenuOpen,"onUpdate:modelValue":e[3]||(e[3]=d=>n(m).miniWidgetManagerVars(n(a).hash).configMenuOpen=d),width:"auto"},{default:y(()=>[c("div",{class:"flex flex-col items-center p-2 pt-1 m-5 rounded-md gap-y-4",style:fe(n(C).globalGlassMenuStyles)},[e[10]||(e[10]=c("p",{class:"text-xl font-semibold m-4"},"Choose a stream to record",-1)),v(pe,{"model-value":o.value,label:"Stream name",items:n(b),"item-title":"name",density:"compact",variant:"outlined","no-data-text":"No streams available.","hide-details":"","return-object":"",theme:"dark",class:"w-[90%]","onUpdate:modelValue":Q},null,8,["model-value","items"]),c("div",Me,[v(q,{class:"w-auto text-uppercase",variant:"text",onClick:e[2]||(e[2]=d=>n(m).miniWidgetManagerVars(n(a).hash).configMenuOpen=!1)},{default:y(()=>e[7]||(e[7]=[k(" Cancel ")])),_:1}),v(q,{class:T(["bg-[#FFFFFF11] hover:bg-[#FFFFFF33]",{"opacity-30 pointer-events-none":w.value}]),size:"large",onClick:D},{default:y(()=>[e[9]||(e[9]=c("span",null,"Record",-1)),w.value?(r(),L(F,{key:0,class:"m-2 animate-spin"},{default:y(()=>e[8]||(e[8]=[k("mdi-loading")])),_:1})):(r(),u("div",Fe))]),_:1},8,["class"])])],4)]),_:1},8,["modelValue"])],64)}}}),We=we(Ce,[["__scopeId","data-v-9e050316"]]);export{We as default};
