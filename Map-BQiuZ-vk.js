import{bJ as ve,bK as Me,bL as Te,bM as $,bN as ke,bO as te,bP as we,bQ as xe,d as Ie,bG as Ae,aG as Se,u as Ve,bR as Ce,p as g,k as _,m as ae,D as ne,bS as w,aZ as Oe,v as De,bT as m,x as Ee,q as y,aK as Ne,ai as _e,bU as ie,aW as Le,aF as He,f as Re,o as j,c as se,a as z,w as le,h as x,n as re,b as p,ak as D,L as U,an as Pe,j as ue,A as F,V as $e,B as ze,M as Ue,C as Fe,b0 as Be,N as Xe,i as We,a9 as Ye,J as Ge,bV as Ze,aM as ce,s as je,e as qe,E as Ke}from"./index-YgbSCX8W.js";function me(i,d){if(i==null)throw new TypeError("assign requires that input parameter not be null or undefined");for(var s in d)Object.prototype.hasOwnProperty.call(d,s)&&(i[s]=d[s]);return i}function Je(i){return me({},i)}var de=1440,Qe=2520,q=43200,eo=86400;function oo(i,d,s){var r,f;ve(2,arguments);var t=xe(),l=(r=(f=s==null?void 0:s.locale)!==null&&f!==void 0?f:t.locale)!==null&&r!==void 0?r:Me;if(!l.formatDistance)throw new RangeError("locale must contain formatDistance property");var b=Te(i,d);if(isNaN(b))throw new RangeError("Invalid time value");var n=me(Je(s),{addSuffix:!!(s!=null&&s.addSuffix),comparison:b}),M,I;b>0?(M=$(d),I=$(i)):(M=$(i),I=$(d));var v=ke(I,M),h=(te(I)-te(M))/1e3,c=Math.round((v-h)/60),A;if(c<2)return s!=null&&s.includeSeconds?v<5?l.formatDistance("lessThanXSeconds",5,n):v<10?l.formatDistance("lessThanXSeconds",10,n):v<20?l.formatDistance("lessThanXSeconds",20,n):v<40?l.formatDistance("halfAMinute",0,n):v<60?l.formatDistance("lessThanXMinutes",1,n):l.formatDistance("xMinutes",1,n):c===0?l.formatDistance("lessThanXMinutes",1,n):l.formatDistance("xMinutes",c,n);if(c<45)return l.formatDistance("xMinutes",c,n);if(c<90)return l.formatDistance("aboutXHours",1,n);if(c<de){var L=Math.round(c/60);return l.formatDistance("aboutXHours",L,n)}else{if(c<Qe)return l.formatDistance("xDays",1,n);if(c<q){var S=Math.round(c/de);return l.formatDistance("xDays",S,n)}else if(c<eo)return A=Math.round(c/q),l.formatDistance("aboutXMonths",A,n)}if(A=we(I,M),A<12){var H=Math.round(c/q);return l.formatDistance("xMonths",H,n)}else{var N=A%12,E=Math.floor(A/12);return N<3?l.formatDistance("aboutXYears",E,n):N<9?l.formatDistance("overXYears",E,n):l.formatDistance("almostXYears",E+1,n)}}function to(i,d){return ve(1,arguments),oo(i,Date.now(),d)}(function(i){let d;if(typeof define=="function"&&define.amd)define(["leaflet"],i);else if(typeof module=="object"&&typeof module.exports=="object")d=require("leaflet"),module.exports=i(d);else{if(typeof window.L>"u")throw"Leaflet must be loaded first";i(window.L)}})(function(i){const d=i.Marker.prototype._initIcon,s=i.Marker.prototype._setPos,r=i.DomUtil.TRANSFORM==="msTransform";i.Marker.addInitHook(function(){let t=this.options.icon&&this.options.icon.options&&this.options.icon.options.iconAnchor;t&&(t=t[0]+"px "+t[1]+"px"),this.options.rotationOrigin=this.options.rotationOrigin||t||"center bottom",this.options.rotationAngle=this.options.rotationAngle||0,this.on("drag",function(l){l.target._applyRotation()})}),i.Marker.include({_initIcon:function(){d.call(this)},_setPos:function(f){s.call(this,f),this._applyRotation()},_applyRotation:function(){this.options.rotationAngle&&(this._icon.style[i.DomUtil.TRANSFORM+"Origin"]=this.options.rotationOrigin,r?this._icon.style[i.DomUtil.TRANSFORM]="rotate("+this.options.rotationAngle+"deg)":this._icon.style[i.DomUtil.TRANSFORM]+=" rotateZ("+this.options.rotationAngle+"deg)")},setRotationAngle:function(f){return this.options.rotationAngle=f,this.update(),this},setRotationOrigin:function(f){return this.options.rotationOrigin=f,this.update(),this}})});const ao={class:"page-base"},no=["id"],so=Ie({__name:"Map",props:{widget:{}},setup(i){var oe;Ae(e=>({71894702:ye.value}));const d=i,s=Se(d).widget,r=Ve(),f=Ce(),t=g(),l=g(15),b=g([-27.5935,-48.55854]),n=g(b.value),M=g(void 0),I=_(()=>`map-${s.value.hash}`);ae.registerUsage(ne.latitude),ae.registerUsage(ne.longitude);const v=new Ze(e=>M.value=e,e=>b.value=e);v.setTrackableTarget(w.VEHICLE,()=>h.value),v.setTrackableTarget(w.HOME,()=>n.value);const h=_(()=>r.coordinates.latitude?[r.coordinates.latitude,r.coordinates.longitude]:void 0),c=_(()=>{var e;return r.attitude.yaw?Oe((e=r.attitude)==null?void 0:e.yaw):0}),{history:A}=De(h),L=_(()=>{const e=r.lastHeartbeat;return e?`${to(e??0,{includeSeconds:!0})} ago`:"never"}),S=g(null),H=async()=>{!n.value||!t.value||v.goToTarget(w.HOME)},N=()=>{R.value=!1,S.value=null,t.value!==void 0&&C.value!==void 0&&t.value.removeLayer(C.value)},E=e=>{e.key==="Escape"&&N()},K=m.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"© OpenStreetMap"}),J=m.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri World Imagery"}),fe={OpenStreetMap:K,"Esri World Imagery":J};Ee(async()=>{t.value=m.map(I.value,{layers:[K,J]}).setView(b.value,l.value),t.value.zoomControl.setPosition("bottomright"),t.value.on("moveend",()=>{if(t.value===void 0)return;let{lat:o,lng:a}=t.value.getCenter();o&&a&&(b.value=[o,a])}),t.value.on("zoomend",()=>{var o;t.value!==void 0&&(l.value=((o=t.value)==null?void 0:o.getZoom())??b.value)}),t.value.on("click",()=>{t.value!==void 0&&t.value.on("click",ee)}),t.value.on("contextmenu",()=>{N()});const e=m.control.layers(fe);t.value.addControl(e),v.enableAutoUpdate(),window.addEventListener("keydown",E),await H()}),y(b,(e,o)=>{var a,u,V;e.toString()!==o.toString()&&((a=t.value)==null||a.panTo(e),(V=(u=O.value)==null?void 0:u.getTooltip())==null||V.setContent(`Home: ${e[0].toFixed(6)}, ${e[1].toFixed(6)}`))}),y(l,(e,o)=>{var a;e!==o&&((a=t.value)==null||a.setZoom(l.value))}),y(d.widget,()=>{var e;(e=t.value)==null||e.invalidateSize()});const B=g(!1),X=g(0),pe=async()=>{for(B.value=!0,X.value=0;f.currentPlanningWaypoints.length>0;)f.currentPlanningWaypoints.pop();const e=async o=>{X.value=o};try{(await r.fetchMission(e)).forEach(a=>{f.currentPlanningWaypoints.push(a),ce.fire({icon:"success",title:"Mission download succeed!",timer:2e3})})}catch(o){ce.fire({icon:"error",title:"Mission download failed",text:o,timer:5e3})}finally{B.value=!1}},ge=()=>{r.startMission()};(oe=navigator==null?void 0:navigator.geolocation)==null||oe.watchPosition(e=>n.value=[e.coords.latitude,e.coords.longitude],e=>console.error(`Failed to get position: (${e.code}) ${e.message}`),{enableHighAccuracy:!1,timeout:5e3,maximumAge:0});let Q=!0;y([n,t],async()=>{n.value===b.value||!t.value||!Q||(await H(),Q=!1)}),y(t,(e,o)=>{t.value!==void 0&&(e==null?void 0:e.options)===void 0&&(t.value=o)}),Ne(()=>{Object.keys(s.value.options).length===0&&(s.value.options={showVehiclePath:!0}),v.enableAutoUpdate()}),_e(()=>{v.disableAutoUpdate(),window.removeEventListener("keydown",E),t.value&&(t.value.off("click",ee),t.value.off("contextmenu"))});const T=g();y(r.coordinates,()=>{if(!(!t.value||!h.value)){if(T.value===void 0){T.value=m.marker(h.value);let e="/src/assets/generic-vehicle-marker.png";r.vehicleType===ie.MAV_TYPE_SURFACE_BOAT?e="/src/assets/blueboat-marker.png":r.vehicleType===ie.MAV_TYPE_SUBMARINE&&(e="/src/assets/brov2-marker.png");const o=new m.Icon({iconUrl:e,iconSize:[64,64],iconAnchor:[32,32]});T.value.setIcon(o);const a=m.tooltip({content:"No data available",className:"waypoint-tooltip"});T.value.bindTooltip(a),t.value.addLayer(T.value)}T.value.setLatLng(h.value)}}),y([h,c,L,()=>r.isArmed],()=>{var e,o,a,u;T.value!==void 0&&((u=T.value.getTooltip())==null||u.setContent(`
    <p>Coordinates: ${(e=h.value)==null?void 0:e[0].toFixed(6)}, ${(o=h.value)==null?void 0:o[1].toFixed(6)}</p>
    <p>Velocity: ${((a=r.velocity.ground)==null?void 0:a.toFixed(2))??"N/A"} m/s</p>
    <p>Heading: ${c.value.toFixed(2)}°</p>
    <p>${r.isArmed?"Armed":"Disarmed"}</p>
    <p>Last seen: ${L.value}</p>
  `),T.value.setRotationAngle(c.value))});const C=g(),O=g();y(n,()=>{if(t.value===void 0)return;const e=n.value;if(e!==void 0){if(O.value===void 0){O.value=m.marker(e);const o=m.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16],html:"H"});O.value.setIcon(o);const a=m.tooltip({content:"No data available",className:"waypoint-tooltip"});O.value.bindTooltip(a),t.value.addLayer(O.value)}O.value.setLatLng(n.value)}});const W=g();y(f.currentPlanningWaypoints,e=>{if(t.value!==void 0){if(W.value===void 0){const o=e.map(a=>a.coordinates);W.value=m.polyline(o,{color:"#358AC3"}).addTo(t.value)}W.value.setLatLngs(e.map(o=>o.coordinates)),e.forEach((o,a)=>{var k;const u=m.marker(o.coordinates),V=m.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16],html:`${a}`});u.setIcon(V),(k=t.value)==null||k.addLayer(u)})}});const R=g(!1),P=Le({top:"0px",left:"0px"}),ee=e=>{var o,a,u,V;if(console.debug("Map click event:",e),C.value!==void 0&&t.value!==void 0&&((o=C.value)==null||o.removeFrom(t.value)),((a=e==null?void 0:e.latlng)==null?void 0:a.lat)!=null&&((u=e==null?void 0:e.latlng)==null?void 0:u.lng)!=null){S.value=[e.latlng.lat,e.latlng.lng],R.value=!0;const k=(V=t.value)==null?void 0:V.getContainer();if(k){const{x:G,y:Z}=k.getBoundingClientRect();P.left=`${e.originalEvent.clientX-G}px`,P.top=`${e.originalEvent.clientY-Z}px`}}else console.error("Invalid event structure:",e);if(t.value!==void 0){C.value=m.marker(S.value);const k=m.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16]});C.value.setIcon(k),t.value.addLayer(C.value)}},Y=g();y(A,e=>{if(t.value===void 0||e===void 0)return;Y.value===void 0&&(Y.value=m.polyline([],{color:"#358AC3"}).addTo(t.value));const o=e.filter(a=>a.snapshot!==void 0).map(a=>a.snapshot);Y.value.setLatLngs(o)});const he=e=>{switch(console.debug(`Map context menu option selected: ${e}.`),e){case"goto":if(S.value){const k=r.coordinates.altitude??0,G=S.value[0],Z=S.value[1];je(()=>{r.goTo(0,0,0,0,G,Z,k)},{command:"GoTo"},qe(Ke.GOTO))}break;default:console.warn("Unknown menu option selected:",e)}R.value=!1},be=He(),ye=_(()=>`${be.widgetBottomClearanceForVisibleArea(s.value)}px`);return(e,o)=>{const a=Re("tooltip");return j(),se(Ge,null,[z("div",ao,[z("div",{id:I.value,ref_key:"map",ref:t,class:"map"},[le(x(U,{class:re(["absolute left-0 m-3 bottom-button bg-slate-50",n.value?"":"active-events-on-disabled"]),color:M.value==p(w).HOME?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-home-map-marker",size:"x-small",disabled:!n.value,onClick:o[0]||(o[0]=D(u=>p(v).goToTarget(p(w).HOME,!0),["stop"])),onDblclick:o[1]||(o[1]=D(u=>p(v).follow(p(w).HOME),["stop"]))},null,8,["class","color","disabled"]),[[a,n.value?void 0:"Home position is currently undefined"]]),le(x(U,{class:re(["absolute m-3 bottom-button left-10 bg-slate-50",h.value?"":"active-events-on-disabled"]),color:M.value==p(w).VEHICLE?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-airplane-marker",size:"x-small",disabled:!h.value,onClick:o[2]||(o[2]=D(u=>p(v).goToTarget(p(w).VEHICLE,!0),["stop"])),onDblclick:o[3]||(o[3]=D(u=>p(v).follow(p(w).VEHICLE),["stop"]))},null,8,["class","color","disabled"]),[[a,h.value?void 0:"Vehicle position is currently undefined"]]),x(U,{class:"absolute m-3 bottom-button left-20 bg-slate-50",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-download",size:"x-small",onClick:D(pe,["stop"])}),x(U,{class:"absolute mb-3 ml-1 bottom-button left-32 bg-slate-50",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-play",size:"x-small",onClick:D(ge,["stop"])})],8,no)]),R.value?(j(),se("div",{key:0,class:"context-menu",style:Pe({top:P.top,left:P.left})},[z("ul",{onClick:o[5]||(o[5]=D(()=>{},["stop"]))},[z("li",{onClick:o[4]||(o[4]=u=>he("goto"))},"GoTo")])],4)):ue("",!0),x(Xe,{modelValue:p(s).managerVars.configMenuOpen,"onUpdate:modelValue":o[7]||(o[7]=u=>p(s).managerVars.configMenuOpen=u),width:"auto"},{default:F(()=>[x($e,{class:"pa-2"},{default:F(()=>[x(ze,null,{default:F(()=>[Ue("Map widget settings")]),_:1}),x(Fe,null,{default:F(()=>[x(Be,{modelValue:p(s).options.showVehiclePath,"onUpdate:modelValue":o[6]||(o[6]=u=>p(s).options.showVehiclePath=u),class:"my-1",label:"Show vehicle path",color:p(s).options.showVehiclePath?"rgb(0, 20, 80)":void 0,"hide-details":""},null,8,["modelValue","color"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),B.value?(j(),We(Ye,{key:1,"model-value":X.value,height:"10",absolute:"",bottom:"",color:"#358AC3"},null,8,["model-value"])):ue("",!0)],64)}}});export{so as default};
