import{c as ne,a8 as se,r as h,bw as pe,w as _,o as fe,h as be,ad as re,l as f,m as b,n as i,_ as ie,bx as ye,b9 as ge,q as n,K as Se,J as we,a9 as he,I as Ve,L as xe,k as C,ac as ke,H as Ie,s as Ne,t as L,F as K,p as ae,Q as D,G as v,N as k,V as Fe,O as Ce,P as De,R as Pe,ah as le,a4 as Q,a5 as oe,W as Re}from"./index-BKn6T0-n.js";(function(){try{var c=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},I=new c.Error().stack;I&&(c._sentryDebugIds=c._sentryDebugIds||{},c._sentryDebugIds[I]="cf188227-b73b-49ab-a978-b816dd8bee7b",c._sentryDebugIdIdentifier="sentry-dbid-cf188227-b73b-49ab-a978-b816dd8bee7b")}catch{}})();const $e={class:"canvas-container"},Me=["width","height"],O=100,ze=60,Le=ne({__name:"VideoPlayerStatsForNerds",props:{width:{type:Number,default:130},height:{type:Number,default:200},updateInterval:{type:Number,default:20},streamName:{type:String,default:""}},setup(c){const I=se(),r=c,P=h(null),u=h([]),N=h([]),a=h([]);let s=null,V=null,d=0,y=0,m=0,T=0,R=0,A=0,E=0,U=0,B=!1,j=0,o=0,e=0,l=0,S=0,W=0,Y=0,q=0,G=1e3,$=30,X=10,ue=120;function de(w,t){return w/t*ze}function Z(){const t=P.value.getContext("2d"),{width:p,height:x}=r;t.clearRect(0,0,p,x);function M(F,J,me){t.strokeStyle=J,t.lineWidth=1,t.beginPath();for(let z=0;z<F.length;z++){const ee=z/(O-1)*p,te=x-de(F[z],me);z===0?t.moveTo(ee,te):t.lineTo(ee,te)}t.stroke()}M(N.value,"rgb(255, 165, 0)",G),M(u.value,"rgb(0, 255, 0)",$),M(a.value,"rgb(255, 0, 0)",X);const g=B?"red":"white",ce=[{label:"Stream",value:r.streamName,color:g},{label:"Size",value:q?`${q}p`:"N/A",color:g},{label:"Packets Lost",value:`${y} (${S.toFixed(0)}%)`,color:g},{label:"Frame drops",value:l,color:g},{label:"Nack",value:R,color:g},{label:"Pli",value:A,color:g},{label:"Fir",value:E,color:g},{label:"Processing ",value:`${j.toFixed(0)}ms`,color:g},{label:"Freezes",value:`${o}(${e.toFixed(1)}s)`,color:g},{label:"Bitrate",value:`${d.toFixed(0)}kbps`,color:"rgb(255, 165, 0)"},{label:"FPS",value:W.toFixed(2),color:"rgb(0, 255, 0)"}];t.font="10px Arial",ce.forEach((F,J)=>{t.fillStyle=F.color,t.fillText(`${F.label}: ${F.value}`,5,12+J*12)}),s=requestAnimationFrame(Z)}const H=new pe({getStatsInterval:100});function ve(){u.value.push(W),N.value.push(d),a.value.push(Math.min(Y,X)),u.value.length>O&&u.value.shift(),N.value.length>O&&N.value.shift(),a.value.length>O&&a.value.shift(),G=Math.max(G,...N.value),$=Math.max($,...u.value),$=Math.min($,ue)}return _(I.activeStreams,w=>{Object.keys(w).forEach(t=>{var x;if(t!==r.streamName)return;const p=(x=w[t])==null?void 0:x.webRtcManager.session;!p||!p.peerConnection||H.peersToMonitor[p.consumerId]||H.addConnection({pc:p.peerConnection,peerId:p.consumerId,connectionId:p.id,remote:!1})})}),fe(()=>{V=setInterval(ve,r.updateInterval),Z(),H.on("stats",w=>{try{const t=w.data.video.inbound[0];if(t===void 0)return;if(B=t.bitrate===0,!isNaN(t.bitrate)){const M=t.bitrate/1e3;d=d*.8+M*.2}Y=t.packetsLost-y,y=t.packetsLost,R=t.nackCount,A=t.pliCount,E=t.firCount,m=t.packetsReceived;let p=t.totalProcessingDelay-T,x=t.framesReceived-U;j=1e3*p/x,U=t.framesReceived,T=t.totalProcessingDelay,S=y/(y+m)*100,o=t.freezeCount,e=t.totalFreezesDuration,l=t.framesDropped,W=t.framesPerSecond??0,q=t.frameHeight}catch(t){console.error(t)}})}),be(()=>{clearInterval(V),cancelAnimationFrame(s)}),re(()=>{H.destroy()}),(w,t)=>(f(),b("div",$e,[i("canvas",{ref_key:"canvasRef",ref:P,width:c.width,height:c.height},null,8,Me)]))}}),Te=ie(Le,[["__scopeId","data-v-4a8ba759"]]),Ae=ye("v-banner-text"),Ee={ref:"videoWidget",class:"video-widget"},Ue={key:1,class:"no-video-alert"},Be={key:2,class:"no-video-alert"},je={key:3,class:"no-video-alert"},He={class:"no-video-alert"},Oe={key:4,class:"no-video-alert"},_e={class:"flex-wrap justify-center d-flex ga-5"},We=ne({__name:"VideoPlayer",props:{widget:{}},setup(c){ge(o=>({"281c6376":n(a).options.videoFitStyle,"20fb88cc":U.value}));const I=Se(),r=se(),P=we(),{namessAvailableAbstractedStreams:u}=he(r),a=Ve(c).widget,s=h(),V=h(),d=h(),y=h(!1);xe(()=>{const o={videoFitStyle:"cover",flipHorizontally:!1,flipVertically:!1,rotationAngle:0,statsForNerds:!1,internalStreamName:void 0};a.value.options=Object.assign({},o,a.value.options),s.value=a.value.options.internalStreamName});const m=C(()=>s.value?r.externalStreamId(s.value):void 0);_(()=>r.streamsCorrespondency,()=>{if(d.value=void 0,!s.value)return;const o=r.externalStreamId(s.value);if(!o)return;const e=r.streamsCorrespondency.find(S=>S.externalId===o);if(!e)return;const l=e.name;s.value!==l&&(s.value=l,a.value.options.internalStreamName=l)},{deep:!0});const T=setInterval(()=>{var o;if(a.value.options.internalStreamName===void 0&&!u.value.isEmpty()&&(a.value.options.internalStreamName=u.value[0],s.value=a.value.options.internalStreamName),m.value!==void 0){const e=r.getMediaStream(m.value);ke(e,d.value)||(d.value=e);const l=((o=r.getStreamData(m.value))==null?void 0:o.connected)??!1;l!==y.value&&(y.value=l)}if(!u.value.isEmpty()&&!u.value.includes(s.value)){if(r.lastRenamedStreamName!==""){s.value=r.lastRenamedStreamName;return}s.value=u.value[0]}},1e3);re(()=>clearInterval(T)),_(s,()=>{a.value.options.internalStreamName=s.value,d.value=void 0}),_(d,()=>{!V.value||!d.value||(V.value.srcObject=d.value,V.value.play().then(()=>console.log("[VideoPlayer] Stream is playing")).catch(o=>{const e=`Failed to play stream. Reason: ${o}`;console.error(`[VideoPlayer] ${e}`)}))});const R=o=>{a.value.options.rotationAngle+=o},A=C(()=>`scale(${a.value.options.flipHorizontally?-1:1}, ${a.value.options.flipVertically?-1:1})`),E=C(()=>`rotate(${a.value.options.rotationAngle??0}deg)`),U=C(()=>`${A.value} ${E.value}`),B=C(()=>{var o;return m.value===void 0?"Unknown.":((o=r.getStreamData(m.value))==null?void 0:o.webRtcManager.signallerStatus)??"Unknown."}),j=C(()=>{var e;if(m.value===void 0)return"Unknown.";const o=r.availableIceIps;return!o.isEmpty()&&!o.find(l=>r.allowedIceIps.includes(l))?`Stream is coming from IPs [${o.join(", ")}], which are not in the list of allowed sources
      [${r.allowedIceIps.join(", ")}].\\n Please check your configuration.`:((e=r.getStreamData(m.value))==null?void 0:e.webRtcManager.streamStatus)??"Unknown."});return(o,e)=>(f(),b(K,null,[i("div",Ee,[n(a).options.statsForNerds?(f(),Ie(Te,{key:0,"stream-name":m.value},null,8,["stream-name"])):Ne("",!0),s.value===void 0?(f(),b("div",Ue,e[8]||(e[8]=[i("span",null,"No video stream selected.",-1)]))):!n(u).isEmpty()&&!n(u).includes(s.value)?(f(),b("div",Be,[i("p",null,'The selected stream "'+L(s.value)+'" is not available.',1),i("p",null,"Available ones are: "+L(n(u).map(l=>`"${l}"`).join(", "))+".",1),e[9]||(e[9]=i("br",null,null,-1)),e[10]||(e[10]=i("p",null," This can happen if you changed vehicles and the stream name in the new one is different from the former, or if the source is not available at all. ",-1)),e[11]||(e[11]=i("br",null,null,-1)),e[12]||(e[12]=i("p",null," Please open this video player configuration and select a new stream from the ones available, or check your source for issues. ",-1))])):y.value?(f(),b("div",Oe,e[17]||(e[17]=[i("p",null,"Loading stream...",-1)]))):(f(),b("div",je,[i("div",He,[i("p",null,[e[14]||(e[14]=i("span",{class:"text-xl font-bold"},"Server status: ",-1)),(f(!0),b(K,null,ae(B.value.toString().split("\\n"),(l,S)=>(f(),b("span",{key:S},[D(L(l)+" ",1),e[13]||(e[13]=i("br",null,null,-1))]))),128))]),i("p",null,[e[16]||(e[16]=i("span",{class:"text-xl font-bold"},"Stream status: ",-1)),(f(!0),b(K,null,ae(j.value.toString().split("\\n"),(l,S)=>(f(),b("span",{key:S},[D(L(l)+" ",1),e[15]||(e[15]=i("br",null,null,-1))]))),128))])])])),i("video",{id:"mainDisplayStream",ref_key:"videoElement",ref:V,muted:"",autoplay:"",playsinline:"",disablePictureInPicture:""}," Your browser does not support the video tag. ",512)],512),v(Re,{modelValue:n(P).widgetManagerVars(n(a).hash).configMenuOpen,"onUpdate:modelValue":e[7]||(e[7]=l=>n(P).widgetManagerVars(n(a).hash).configMenuOpen=l),width:"auto"},{default:k(()=>[v(Fe,{class:"pa-4 text-white",style:Ce([{"border-radius":"15px"},n(I).globalGlassMenuStyles])},{default:k(()=>[v(De,{class:"text-center"},{default:k(()=>e[18]||(e[18]=[D("Video widget config")])),_:1}),v(Pe,{class:"flex flex-col gap-y-4"},{default:k(()=>[v(le,{modelValue:s.value,"onUpdate:modelValue":e[0]||(e[0]=l=>s.value=l),label:"Stream name",class:"my-3",items:n(u),"item-title":"name",density:"compact",variant:"outlined","no-data-text":"No streams available.","hide-details":"","return-object":""},null,8,["modelValue","items"]),v(le,{modelValue:n(a).options.videoFitStyle,"onUpdate:modelValue":e[1]||(e[1]=l=>n(a).options.videoFitStyle=l),label:"Fit style",class:"my-3",items:["cover","fill","contain"],"item-title":"style",density:"compact",variant:"outlined","no-data-text":"No streams available.","hide-details":"","return-object":""},null,8,["modelValue"]),v(Ae,null,{default:k(()=>[D('Saved stream name: "'+L(n(a).options.internalStreamName)+'"',1)]),_:1}),v(Q,{modelValue:n(a).options.flipHorizontally,"onUpdate:modelValue":e[2]||(e[2]=l=>n(a).options.flipHorizontally=l),class:"my-1",label:"Flip horizontally",color:n(a).options.flipHorizontally?"white":void 0,"hide-details":""},null,8,["modelValue","color"]),v(Q,{modelValue:n(a).options.flipVertically,"onUpdate:modelValue":e[3]||(e[3]=l=>n(a).options.flipVertically=l),class:"my-1",label:"Flip vertically",color:n(a).options.flipVertically?"white":void 0,"hide-details":""},null,8,["modelValue","color"]),v(Q,{modelValue:n(a).options.statsForNerds,"onUpdate:modelValue":e[4]||(e[4]=l=>n(a).options.statsForNerds=l),class:"my-1",label:"Stats for nerds",color:n(a).options.statsForNerds?"white":void 0,"hide-details":""},null,8,["modelValue","color"]),i("div",_e,[v(oe,{"prepend-icon":"mdi-file-rotate-left",variant:"outlined",onClick:e[5]||(e[5]=l=>R(-90))},{default:k(()=>e[19]||(e[19]=[D(" Rotate Left")])),_:1}),v(oe,{"prepend-icon":"mdi-file-rotate-right",variant:"outlined",onClick:e[6]||(e[6]=l=>R(90))},{default:k(()=>e[20]||(e[20]=[D(" Rotate Right")])),_:1})])]),_:1})]),_:1},8,["style"])]),_:1},8,["modelValue"])],64))}}),Ge=ie(We,[["__scopeId","data-v-f57695a6"]]);export{Ge as default};
//# sourceMappingURL=VideoPlayer-QpSkZey4.js.map
