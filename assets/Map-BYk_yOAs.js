import{bC as Ee,bD as Ae,bE as Ne,bF as Z,f as ze,bG as ke,bH as $e,bI as Pe,c as Fe,a_ as _e,J as Be,K as Ue,a8 as Re,u as Xe,ak as We,r as v,k as A,M as xe,Y as Te,L as Ye,bJ as i,j as Ge,w as h,o as Ze,bK as b,ae as qe,bL as Ke,aF as je,bM as Je,bN as Ce,aC as Qe,y as ea,l as E,m as ie,n as P,G as q,T as K,I as F,v as re,q as r,as as D,a6 as j,s as L,O as J,H as _,N as Q,V as aa,P as ta,Q as oa,R as na,a5 as la,W as sa,bO as ia,F as ra,z as ua,B as ca,E as da,bP as ue,_ as va}from"./index-Cb4dgWtQ.js";function Se(m,y){if(m==null)throw new TypeError("assign requires that input parameter not be null or undefined");for(var l in y)Object.prototype.hasOwnProperty.call(y,l)&&(m[l]=y[l]);return m}function ma(m){return Se({},m)}var Ie=1440,fa=2520,ce=43200,pa=86400;function ga(m,y,l){var N,z;Ee(2,arguments);var u=Pe(),n=(N=(z=l==null?void 0:l.locale)!==null&&z!==void 0?z:u.locale)!==null&&N!==void 0?N:Ae;if(!n.formatDistance)throw new RangeError("locale must contain formatDistance property");var t=Ne(m,y);if(isNaN(t))throw new RangeError("Invalid time value");var s=Se(ma(l),{addSuffix:!!(l!=null&&l.addSuffix),comparison:t}),f,d;t>0?(f=Z(y),d=Z(m)):(f=Z(m),d=Z(y));var x=ze(d,f),T=(ke(d)-ke(f))/1e3,c=Math.round((x-T)/60),C;if(c<2)return l!=null&&l.includeSeconds?x<5?n.formatDistance("lessThanXSeconds",5,s):x<10?n.formatDistance("lessThanXSeconds",10,s):x<20?n.formatDistance("lessThanXSeconds",20,s):x<40?n.formatDistance("halfAMinute",0,s):x<60?n.formatDistance("lessThanXMinutes",1,s):n.formatDistance("xMinutes",1,s):c===0?n.formatDistance("lessThanXMinutes",1,s):n.formatDistance("xMinutes",c,s);if(c<45)return n.formatDistance("xMinutes",c,s);if(c<90)return n.formatDistance("aboutXHours",1,s);if(c<Ie){var B=Math.round(c/60);return n.formatDistance("aboutXHours",B,s)}else{if(c<fa)return n.formatDistance("xDays",1,s);if(c<ce){var U=Math.round(c/Ie);return n.formatDistance("xDays",U,s)}else if(c<pa)return C=Math.round(c/ce),n.formatDistance("aboutXMonths",C,s)}if(C=$e(d,f),C<12){var ee=Math.round(c/ce);return n.formatDistance("xMonths",ee,s)}else{var R=C%12,O=Math.floor(C/12);return R<3?n.formatDistance("aboutXYears",O,s):R<9?n.formatDistance("overXYears",O,s):n.formatDistance("almostXYears",O+1,s)}}function ha(m,y){return Ee(1,arguments),ga(m,Date.now(),y)}const ba=""+new URL("blueboat-marker-DyHmCFOq.png",import.meta.url).href,ya=""+new URL("brov2-marker-CBzp11FX.png",import.meta.url).href,Ma=""+new URL("generic-vehicle-marker-SovxT5Tc.png",import.meta.url).href,wa=["id"],ka=Fe({__name:"Map",props:{widget:{}},setup(m){var we;_e(e=>({d3ecf718:Oe.value}));const y=m,l=Be(y).widget,N=Ue(),{showDialog:z}=Re(),u=Xe(),n=We(),t=v(),s=v(n.defaultMapZoom),f=v(n.defaultMapCenter),d=v(),x=A(()=>`map-${l.value.hash}`),T=v(!1);xe.registerUsage(Te.latitude),xe.registerUsage(Te.longitude),Ye(()=>{Object.keys(l.value.options).length===0&&(l.value.options={showVehiclePath:!0}),p.enableAutoUpdate()});const c=i.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"© OpenStreetMap"}),C=i.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri World Imagery"}),B=i.tileLayer("https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png",{maxZoom:18,attribution:"© OpenSeaMap contributors"}),U=i.tileLayer.wms("https://geoserver.openseamap.org/geoserver/gwc/service/wms",{layers:"gebco2021:gebco_2021",format:"image/png",transparent:!0,version:"1.1.1",attribution:"© GEBCO, OpenSeaMap",tileSize:256,maxZoom:19}),ee={OpenStreetMap:c,"Esri World Imagery":C},R={Seamarks:B,"Marine Profile":U},O=v(),de=Ge(O),ve=i.control.zoom({position:"bottomright"}),me=i.control.layers(ee,R);h(T,()=>{t.value!==void 0&&(T.value?(t.value.addControl(ve),t.value.addControl(me)):(t.value.removeControl(ve),t.value.removeControl(me)))}),h(de,()=>{T.value=de.value}),Ze(async()=>{t.value=i.map(x.value,{layers:[c,C,B,U],attributionControl:!1}).setView(f.value,s.value),t.value.removeControl(t.value.zoomControl),t.value.on("moveend",()=>{if(t.value===void 0)return;let{lat:e,lng:a}=t.value.getCenter();e&&a&&(f.value=[e,a])}),t.value.on("zoomend",()=>{var e;t.value!==void 0&&(s.value=((e=t.value)==null?void 0:e.getZoom())??f.value)}),t.value.on("click",()=>{t.value!==void 0&&t.value.on("click",ge)}),t.value.on("contextmenu",()=>{be()}),p.enableAutoUpdate(),window.addEventListener("keydown",ye),g.value?p.goToTarget(b.VEHICLE):p.goToTarget(b.HOME)}),qe(()=>{p.disableAutoUpdate(),window.removeEventListener("keydown",ye),t.value&&(t.value.off("click",ge),t.value.off("contextmenu"))}),h(f,(e,a)=>{var o,M,k;e.toString()!==a.toString()&&((o=t.value)==null||o.panTo(e),(k=(M=S.value)==null?void 0:M.getTooltip())==null||k.setContent(`Home: ${e[0].toFixed(6)}, ${e[1].toFixed(6)}`))}),h(t,(e,a)=>{t.value!==void 0&&(e==null?void 0:e.options)===void 0&&(t.value=a)}),h(s,(e,a)=>{var o;e!==a&&((o=t.value)==null||o.setZoom(s.value))}),h(y.widget,()=>{var e;(e=t.value)==null||e.invalidateSize()});const X=v(void 0),p=new Ke(e=>X.value=e,e=>f.value=e);p.setTrackableTarget(b.VEHICLE,()=>g.value),p.setTrackableTarget(b.HOME,()=>d.value);const g=A(()=>u.coordinates.latitude?[u.coordinates.latitude,u.coordinates.longitude]:void 0),ae=A(()=>{var e;return u.attitude.yaw?je((e=u.attitude)==null?void 0:e.yaw):0}),fe=A(()=>{const e=u.lastHeartbeat;return e?`${ha(e??0,{includeSeconds:!0})} ago`:"never"}),{history:Ve}=Je(g);(we=navigator==null?void 0:navigator.geolocation)==null||we.watchPosition(e=>d.value=[e.coords.latitude,e.coords.longitude],e=>console.error(`Failed to get position: (${e.code}) ${e.message}`),{enableHighAccuracy:!1,timeout:5e3,maximumAge:0});let pe=!0;h([d,t],async()=>{d.value===f.value||!t.value||!pe||(p.goToTarget(b.HOME),pe=!1)});const I=v();h(u.coordinates,()=>{if(!(!t.value||!g.value)){if(I.value===void 0){let e=Ma;u.vehicleType===Ce.MAV_TYPE_SURFACE_BOAT?e=ba:u.vehicleType===Ce.MAV_TYPE_SUBMARINE&&(e=ya);const a=i.divIcon({className:"vehicle-marker",html:`<img src="${e}" style="width: 64px; height: 64px;">`,iconSize:[64,64],iconAnchor:[32,32]});I.value=i.marker(g.value,{icon:a});const o=i.tooltip({content:"No data available",className:"waypoint-tooltip",offset:[40,0]});I.value.bindTooltip(o),t.value.addLayer(I.value)}I.value.setLatLng(g.value)}}),h(g,(e,a)=>{X.value===b.VEHICLE||a!==void 0||p.follow(b.VEHICLE)}),h([g,ae,fe,()=>u.isArmed],()=>{var a,o,M,k,w;if(I.value===void 0)return;(k=I.value.getTooltip())==null||k.setContent(`
    <p>Coordinates: ${(a=g.value)==null?void 0:a[0].toFixed(6)}, ${(o=g.value)==null?void 0:o[1].toFixed(6)}</p>
    <p>Velocity: ${((M=u.velocity.ground)==null?void 0:M.toFixed(2))??"N/A"} m/s</p>
    <p>Heading: ${ae.value.toFixed(2)}°</p>
    <p>${u.isArmed?"Armed":"Disarmed"}</p>
    <p>Last seen: ${fe.value}</p>
  `);const e=(w=I.value.getElement())==null?void 0:w.querySelector("img");e&&(e.style.transform=`rotate(${ae.value}deg)`)});const S=v();h(d,()=>{if(t.value===void 0)return;const e=d.value;if(e!==void 0){if(S.value===void 0){S.value=i.marker(e);const a=i.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16],html:"H"});S.value.setIcon(a);const o=i.tooltip({content:"No data available",className:"waypoint-tooltip"});S.value.bindTooltip(o),t.value.addLayer(S.value)}S.value.setLatLng(d.value)}});const te=v();h(n.currentPlanningWaypoints,e=>{if(t.value!==void 0){if(te.value===void 0){const a=e.map(o=>o.coordinates);te.value=i.polyline(a,{color:"#358AC3"}).addTo(t.value)}te.value.setLatLngs(e.map(a=>a.coordinates)),e.forEach((a,o)=>{var w;const M=i.marker(a.coordinates),k=i.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16],html:`${o}`});M.setIcon(k),(w=t.value)==null||w.addLayer(M)})}});const oe=v();h(Ve,e=>{if(t.value===void 0||e===void 0)return;oe.value===void 0&&(oe.value=i.polyline([],{color:"#ffff00"}).addTo(t.value));const a=e.filter(o=>o.snapshot!==void 0).map(o=>o.snapshot);oe.value.setLatLngs(a)});const W=v(!1),H=v(null),Y=Qe({top:"0px",left:"0px"}),V=v(),ge=e=>{var a,o,M,k;if(V.value!==void 0&&t.value!==void 0&&((a=V.value)==null||a.removeFrom(t.value)),((o=e==null?void 0:e.latlng)==null?void 0:o.lat)!=null&&((M=e==null?void 0:e.latlng)==null?void 0:M.lng)!=null){H.value=[e.latlng.lat,e.latlng.lng],W.value=!0;const w=(k=t.value)==null?void 0:k.getContainer();if(w){const{x:le,y:se}=w.getBoundingClientRect();Y.left=`${e.originalEvent.clientX-le}px`,Y.top=`${e.originalEvent.clientY-se}px`}}else console.error("Invalid event structure:",e);if(t.value!==void 0){V.value=i.marker(H.value);const w=i.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16]});V.value.setIcon(w),t.value.addLayer(V.value)}},he=e=>{switch(e){case"goto":if(H.value){const w=u.coordinates.altitude??0,le=H.value[0],se=H.value[1];ua(async()=>{try{await u.goTo(0,0,0,0,le,se,w)}catch(He){ue({message:He,variant:"error"})}},{command:"GoTo"},ca(da.GOTO))}break;case"set-default-map-position":n.setDefaultMapPosition(f.value,s.value);break;default:console.warn("Unknown menu option selected:",e)}W.value=!1},be=()=>{W.value=!1,H.value=null,t.value!==void 0&&V.value!==void 0&&t.value.removeLayer(V.value)},ye=e=>{e.key==="Escape"&&be()},G=v(!1),ne=v(0),De=async()=>{for(G.value=!0,ne.value=0;n.currentPlanningWaypoints.length>0;)n.currentPlanningWaypoints.pop();const e=async a=>{ne.value=a};try{(await u.fetchMission(e)).forEach(o=>{n.currentPlanningWaypoints.push(o)}),ue({variant:"success",message:"Mission download succeed!",duration:3e3})}catch(a){z({variant:"error",title:"Mission download failed",message:a,timer:5e3})}finally{G.value=!1}},Le=async()=>{try{await u.startMission()}catch{ue({message:"Failed to start mission.",variant:"error"})}},$=ea(),Oe=A(()=>`${Math.max(-$.widgetClearanceForVisibleArea(l.value).bottom,0)}px`),Me=A(()=>`${Math.max(-$.widgetClearanceForVisibleArea(l.value).top,0)}px`);return(e,a)=>(E(),ie(ra,null,[P("div",{ref_key:"mapBase",ref:O,class:re(["page-base",r($).editingMode?"pointer-events-none":"pointer-events-auto"])},[P("div",{id:x.value,ref_key:"map",ref:t,class:"map"},[T.value?q((E(),F(j,{key:0,class:re(["absolute left-0 m-3 bottom-button bg-slate-50",d.value?"":"active-events-on-disabled"]),color:X.value==r(b).HOME?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-home-map-marker",size:"x-small",disabled:!d.value,onClick:a[0]||(a[0]=D(o=>r(p).goToTarget(r(b).HOME,!0),["stop"])),onDblclick:a[1]||(a[1]=D(o=>r(p).follow(r(b).HOME),["stop"]))},null,8,["class","color","disabled"])),[[K,d.value?"Center map on home position.":"Home position is currently undefined."]]):L("",!0),T.value?q((E(),F(j,{key:1,class:re(["absolute m-3 bottom-button left-10 bg-slate-50",g.value?"":"active-events-on-disabled"]),color:X.value==r(b).VEHICLE?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-airplane-marker",size:"x-small",disabled:!g.value,onClick:a[2]||(a[2]=D(o=>r(p).goToTarget(r(b).VEHICLE,!0),["stop"])),onDblclick:a[3]||(a[3]=D(o=>r(p).follow(r(b).VEHICLE),["stop"]))},null,8,["class","color","disabled"])),[[K,g.value?"Center map on vehicle position.":"Vehicle position is currently undefined."]]):L("",!0),T.value?q((E(),F(j,{key:2,class:"absolute m-3 bottom-button left-20 bg-slate-50",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-download",size:"x-small",onClick:D(De,["stop"])},null,512)),[[K,"Download the mission that is stored in the vehicle."]]):L("",!0),T.value?q((E(),F(j,{key:3,class:"absolute mb-3 ml-1 bottom-button left-32 bg-slate-50",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-play",size:"x-small",onClick:D(Le,["stop"])},null,512)),[[K,"Execute the mission that is stored in the vehicle."]]):L("",!0)],8,wa)],2),W.value?(E(),ie("div",{key:0,class:"context-menu",style:J({top:Y.top,left:Y.left})},[P("ul",{onClick:a[6]||(a[6]=D(()=>{},["stop"]))},[P("li",{onClick:a[4]||(a[4]=o=>he("goto"))},"GoTo"),P("li",{onClick:a[5]||(a[5]=o=>he("set-default-map-position"))},"Set default map position")])],4)):L("",!0),_(sa,{modelValue:r($).widgetManagerVars(r(l).hash).configMenuOpen,"onUpdate:modelValue":a[8]||(a[8]=o=>r($).widgetManagerVars(r(l).hash).configMenuOpen=o),width:"auto"},{default:Q(()=>[_(aa,{class:"pa-2",style:J(r(N).globalGlassMenuStyles)},{default:Q(()=>[_(ta,{class:"text-center"},{default:Q(()=>a[9]||(a[9]=[oa("Map widget settings")])),_:1}),_(na,null,{default:Q(()=>[_(la,{modelValue:r(l).options.showVehiclePath,"onUpdate:modelValue":a[7]||(a[7]=o=>r(l).options.showVehiclePath=o),class:"my-1",label:"Show vehicle path",color:r(l).options.showVehiclePath?"white":void 0,"hide-details":""},null,8,["modelValue","color"])]),_:1})]),_:1},8,["style"])]),_:1},8,["modelValue"]),G.value?(E(),F(ia,{key:1,"model-value":ne.value,height:"10",absolute:"",bottom:"",color:"white",style:J(`top: ${Me.value}`)},null,8,["model-value","style"])):L("",!0),G.value?(E(),ie("p",{key:2,style:J({top:Me.value}),class:"absolute left-[7px] mt-4 flex text-md font-bold text-white z-30 drop-shadow-md"}," Loading mission... ",4)):L("",!0)],64))}}),Ta=va(ka,[["__scopeId","data-v-a603726f"]]);export{Ta as default};
