import{c as se,ah as ce,r as v,ca as Se,w as H,o as ve,j as me,am as pe,m,n as c,p as s,_ as ne,h as _,cb as he,aY as de,q as u,V as j,v as le,F as K,C as oe,y as xe,B as R,bD as Ve,z as i,t as we,Q as ke,e as Ce,ai as Fe,R as Ie,s as ee,G as L,E as k,U as _e,x as $e,W as Ne,X as Pe,ap as Re,H as te,cc as De,cd as ae,c2 as Te,$ as Me}from"./index-BBy-9iLM.js";import{V as ze,a as Ee,b as Ue,c as Be}from"./VExpansionPanels-C3z3Jr5A.js";const Ae={class:"canvas-container"},Le=["width","height"],J=100,He=60,je=se({__name:"VideoPlayerStatsForNerds",props:{width:{type:Number,default:130},height:{type:Number,default:200},updateInterval:{type:Number,default:20},streamName:{type:String,default:""}},setup($){const D=ce(),r=$,b=v(null),d=v([]),S=v([]),a=v([]);let n=null,h=null,p=0,x=0,f=0,V=0,y=0,C=0,T=0,g=0,W=!1,E=0,O=0,G=0,q=0,Y=0,U=0,Q=0,M=0,o=1e3,e=30,l=10,N=120;function fe(I,t){return I/t*He}function re(){const t=b.value.getContext("2d"),{width:w,height:P}=r;t.clearRect(0,0,w,P);function B(z,Z,ye){t.strokeStyle=Z,t.lineWidth=1,t.beginPath();for(let A=0;A<z.length;A++){const ie=A/(J-1)*w,ue=P-fe(z[A],ye);A===0?t.moveTo(ie,ue):t.lineTo(ie,ue)}t.stroke()}B(S.value,"rgb(255, 165, 0)",o),B(d.value,"rgb(0, 255, 0)",e),B(a.value,"rgb(255, 0, 0)",l);const F=W?"red":"white",be=[{label:"Stream",value:r.streamName,color:F},{label:"Size",value:M?`${M}p`:"N/A",color:F},{label:"Packets Lost",value:`${x} (${Y.toFixed(0)}%)`,color:F},{label:"Frame drops",value:q,color:F},{label:"Nack",value:y,color:F},{label:"Pli",value:C,color:F},{label:"Fir",value:T,color:F},{label:"Processing ",value:`${E.toFixed(0)}ms`,color:F},{label:"Freezes",value:`${O}(${G.toFixed(1)}s)`,color:F},{label:"Bitrate",value:`${p.toFixed(0)}kbps`,color:"rgb(255, 165, 0)"},{label:"FPS",value:U.toFixed(2),color:"rgb(0, 255, 0)"}];t.font="10px Arial",be.forEach((z,Z)=>{t.fillStyle=z.color,t.fillText(`${z.label}: ${z.value}`,5,12+Z*12)}),n=requestAnimationFrame(re)}const X=new Se({getStatsInterval:100});function ge(){d.value.push(U),S.value.push(p),a.value.push(Math.min(Q,l)),d.value.length>J&&d.value.shift(),S.value.length>J&&S.value.shift(),a.value.length>J&&a.value.shift(),o=Math.max(o,...S.value),e=Math.max(e,...d.value),e=Math.min(e,N)}return H(D.activeStreams,I=>{Object.keys(I).forEach(t=>{var P;if(t!==r.streamName)return;const w=(P=I[t])==null?void 0:P.webRtcManager.session;!w||!w.peerConnection||X.peersToMonitor[w.consumerId]||X.addConnection({pc:w.peerConnection,peerId:w.consumerId,connectionId:w.id,remote:!1})})}),ve(()=>{h=setInterval(ge,r.updateInterval),re(),X.on("stats",I=>{try{const t=I.data.video.inbound[0];if(t===void 0)return;if(W=t.bitrate===0,!isNaN(t.bitrate)){const B=t.bitrate/1e3;p=p*.8+B*.2}Q=t.packetsLost-x,x=t.packetsLost,y=t.nackCount,C=t.pliCount,T=t.firCount,f=t.packetsReceived;let w=t.totalProcessingDelay-V,P=t.framesReceived-g;E=1e3*w/P,g=t.framesReceived,V=t.totalProcessingDelay,Y=x/(x+f)*100,O=t.freezeCount,G=t.totalFreezesDuration,q=t.framesDropped,U=t.framesPerSecond??0,M=t.frameHeight}catch(t){console.error(t)}})}),me(()=>{clearInterval(h),cancelAnimationFrame(n)}),pe(()=>{X.destroy()}),(I,t)=>(c(),m("div",Ae,[s("canvas",{ref_key:"canvasRef",ref:b,width:$.width,height:$.height},null,8,Le)]))}}),We=ne(je,[["__scopeId","data-v-4a8ba759"]]),Oe={class:"webrtc-debug-console"},Ge={class:"console-header"},qe={class:"console-controls"},Ye={key:0,class:"no-messages"},Qe={class:"message-timestamp"},Xe={class:"message-type"},Je={class:"message-content"},Ke=se({__name:"WebRTCDebugConsole",props:{streamId:{}},setup($){const D=$,r=he(),b=v(),d=v(!0),S=v(!0),a=_(()=>r.getMessagesForStream(D.streamId)),n=f=>f.toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"}),h=()=>{b.value&&(b.value.scrollTop=b.value.scrollHeight,S.value=!0)},p=()=>{r.clearMessagesForStream(D.streamId)},x=()=>{if(!b.value)return;const{scrollTop:f,scrollHeight:V,clientHeight:y}=b.value,C=50;d.value=f+y>=V-C,d.value?S.value=!0:S.value=!1};return H(a,async()=>{S.value&&(await de(),h())},{deep:!0}),ve(()=>{de(()=>{h()})}),me(()=>{}),(f,V)=>(c(),m("div",Oe,[s("div",Ge,[s("div",qe,[u(j,{size:"x-small",variant:"text",color:"white",disabled:d.value,icon:"mdi-arrow-down",onClick:h},null,8,["disabled"]),u(j,{size:"x-small",variant:"text",color:"white",icon:"mdi-delete",onClick:p})])]),s("div",{ref_key:"consoleContainer",ref:b,class:"console-content",onScroll:x},[a.value.length===0?(c(),m("div",Ye,"No debug messages yet...")):le("",!0),(c(!0),m(K,null,oe(a.value,(y,C)=>(c(),m("div",{key:C,class:xe(["console-message",[`message-${y.type}`]])},[s("span",Qe,R(n(y.timestamp)),1),s("span",Xe,"["+R(y.type.toUpperCase())+"]",1),s("span",Je,R(y.message),1)],2))),128))],544)]))}}),Ze=ne(Ke,[["__scopeId","data-v-97d2f10f"]]),et={ref:"videoWidget",class:"video-widget"},tt={key:1,class:"no-video-alert"},at={key:2,class:"no-video-alert"},lt={key:3,class:"no-video-alert"},ot={class:"no-video-alert"},st={key:4,class:"no-video-alert"},nt={class:"d-flex justify-center mb-4"},rt={class:"d-flex justify-center gap-12 my-6"},it={class:"d-flex flex-column"},ut={class:"d-flex flex-column"},dt={class:"d-flex justify-center align-center gap-2 mb-2"},ct={key:1,class:"text-center opacity-60 py-4"},vt=se({__name:"VideoPlayer",props:{widget:{}},setup($){Ve(o=>({"61d4f053":Y.value,"5933e06f":i(a).options.videoFitStyle}));const D=ke(),r=ce(),b=Ce(),{namessAvailableAbstractedStreams:d}=Fe(r),a=we($).widget,n=v(),h=v(),p=v(),x=v(!1),f=v(!1),V=v(0),y=v(),C=v(!1),T=v();Ie(()=>{const o={videoFitStyle:"cover",flipHorizontally:!1,flipVertically:!1,rotationAngle:0,statsForNerds:!1,internalStreamName:void 0};a.value.options=Object.assign({},o,a.value.options),n.value=a.value.options.internalStreamName,setTimeout(()=>{C.value=!0},5e3)});const g=_(()=>n.value?r.externalStreamId(n.value):void 0);H(()=>r.streamsCorrespondency,()=>{if(p.value=void 0,!n.value)return;const o=r.externalStreamId(n.value);if(!o)return;const e=r.streamsCorrespondency.find(N=>N.externalId===o);if(!e)return;const l=e.name;n.value!==l&&(n.value=l,a.value.options.internalStreamName=l)},{deep:!0});const W=setInterval(()=>{var o;if(a.value.options.internalStreamName===void 0&&!d.value.isEmpty()&&(a.value.options.internalStreamName=d.value[0],n.value=a.value.options.internalStreamName),g.value!==void 0){const e=r.getMediaStream(g.value);e!==p.value&&(p.value=e);const l=((o=r.getStreamData(g.value))==null?void 0:o.connected)??!1;l!==x.value&&(x.value=l)}if(!d.value.isEmpty()&&!d.value.includes(n.value)){if(r.lastRenamedStreamName!==""){n.value=r.lastRenamedStreamName;return}n.value=d.value[0]}},1e3);pe(()=>clearInterval(W)),H(n,()=>{a.value.options.internalStreamName=n.value,p.value=void 0}),H(p,()=>{!h.value||!p.value||(h.value.srcObject=p.value,h.value.play().then(()=>console.log("[VideoPlayer] Stream is playing")).catch(o=>{const e=`Failed to play stream. Reason: ${o}`;console.error(`[VideoPlayer] ${e}`)}))});const E=o=>{a.value.options.rotationAngle+=o},O=()=>{if(f.value||!n.value)return;y.value=n.value,f.value=!0,V.value=0,n.value=void 0;const o=setInterval(()=>{V.value+=100/30,V.value>=100&&clearInterval(o)},100);setTimeout(()=>{n.value=y.value,f.value=!1,V.value=0,clearInterval(o)},3e3)},G=_(()=>`scale(${a.value.options.flipHorizontally?-1:1}, ${a.value.options.flipVertically?-1:1})`),q=_(()=>`rotate(${a.value.options.rotationAngle??0}deg)`),Y=_(()=>`${G.value} ${q.value}`),U=_(()=>{var o;return g.value===void 0?"Unknown.":((o=r.getStreamData(g.value))==null?void 0:o.webRtcManager.signallerStatus)??"Unknown."}),Q=_(()=>{var e;if(g.value===void 0)return"Unknown.";const o=r.availableIceIps;return!o.isEmpty()&&!o.find(l=>r.allowedIceIps.includes(l))?`Stream is coming from IPs [${o.join(", ")}], which are not in the list of allowed sources
      [${r.allowedIceIps.join(", ")}].\\n Please check your configuration.`:((e=r.getStreamData(g.value))==null?void 0:e.webRtcManager.streamStatus)??"Unknown."}),M=_(()=>{if(!g.value)return;const o=r.getStreamData(g.value);return o==null?void 0:o.webRtcManager.getDebugStreamId()});return(o,e)=>(c(),m(K,null,[s("div",et,[i(a).options.statsForNerds?(c(),ee(We,{key:0,"stream-name":g.value},null,8,["stream-name"])):le("",!0),n.value===void 0?(c(),m("div",tt,e[9]||(e[9]=[s("span",null,"No video stream selected.",-1)]))):!i(d).isEmpty()&&!i(d).includes(n.value)?(c(),m("div",at,[s("p",null,'The selected stream "'+R(n.value)+'" is not available.',1),s("p",null,"Available ones are: "+R(i(d).map(l=>`"${l}"`).join(", "))+".",1),e[10]||(e[10]=s("br",null,null,-1)),e[11]||(e[11]=s("p",null," This can happen if you changed vehicles and the stream name in the new one is different from the former, or if the source is not available at all. ",-1)),e[12]||(e[12]=s("br",null,null,-1)),e[13]||(e[13]=s("p",null," Please open this video player configuration and select a new stream from the ones available, or check your source for issues. ",-1))])):x.value?(c(),m("div",st,e[18]||(e[18]=[s("p",null,"Loading stream...",-1)]))):(c(),m("div",lt,[s("div",ot,[s("p",null,[e[15]||(e[15]=s("span",{class:"text-xl font-bold"},"Server status: ",-1)),(c(!0),m(K,null,oe(U.value.toString().split("\\n"),(l,N)=>(c(),m("span",{key:N},[L(R(l)+" ",1),e[14]||(e[14]=s("br",null,null,-1))]))),128))]),s("p",null,[e[17]||(e[17]=s("span",{class:"text-xl font-bold"},"Stream status: ",-1)),(c(!0),m(K,null,oe(Q.value.toString().split("\\n"),(l,N)=>(c(),m("span",{key:N},[L(R(l)+" ",1),e[16]||(e[16]=s("br",null,null,-1))]))),128))])])])),s("video",{id:"mainDisplayStream",ref_key:"videoElement",ref:h,muted:"",autoplay:"",playsinline:"",disablePictureInPicture:""}," Your browser does not support the video tag. ",512)],512),u(Me,{modelValue:i(b).widgetManagerVars(i(a).hash).configMenuOpen,"onUpdate:modelValue":e[8]||(e[8]=l=>i(b).widgetManagerVars(i(a).hash).configMenuOpen=l),width:T.value?800:500},{default:k(()=>[u(_e,{class:"pa-4",style:$e([i(D).globalGlassMenuStyles,{"border-radius":"15px"}])},{default:k(()=>[u(Ne,{class:"text-center"},{default:k(()=>e[19]||(e[19]=[L("Video widget config")])),_:1,__:[19]}),u(Pe,null,{default:k(()=>[s("div",nt,[u(Re,{modelValue:n.value,"onUpdate:modelValue":e[0]||(e[0]=l=>n.value=l),label:"Stream name",items:i(d),"item-title":"name",density:"compact",variant:"outlined","no-data-text":"No streams available.","hide-details":"","return-object":"",style:{"max-width":"300px"}},null,8,["modelValue","items"])]),s("div",rt,[s("div",it,[u(te,{modelValue:i(a).options.flipHorizontally,"onUpdate:modelValue":e[1]||(e[1]=l=>i(a).options.flipHorizontally=l),label:"Flip horizontally",color:i(a).options.flipHorizontally?"white":void 0,density:"compact","hide-details":""},null,8,["modelValue","color"]),u(te,{modelValue:i(a).options.flipVertically,"onUpdate:modelValue":e[2]||(e[2]=l=>i(a).options.flipVertically=l),label:"Flip vertically",color:i(a).options.flipVertically?"white":void 0,density:"compact","hide-details":""},null,8,["modelValue","color"]),u(te,{modelValue:i(a).options.statsForNerds,"onUpdate:modelValue":e[3]||(e[3]=l=>i(a).options.statsForNerds=l),label:"Stats for nerds",color:i(a).options.statsForNerds?"white":void 0,density:"compact","hide-details":""},null,8,["modelValue","color"])]),s("div",ut,[e[20]||(e[20]=s("span",{class:"text-caption opacity-70 mb-1"},"Fit style",-1)),u(De,{modelValue:i(a).options.videoFitStyle,"onUpdate:modelValue":e[4]||(e[4]=l=>i(a).options.videoFitStyle=l),density:"compact","hide-details":""},{default:k(()=>[u(ae,{label:"Cover",value:"cover"}),u(ae,{label:"Fill",value:"fill"}),u(ae,{label:"Contain",value:"contain"})]),_:1},8,["modelValue"])])]),s("div",dt,[u(j,{icon:"mdi-rotate-left",variant:"text",onClick:e[5]||(e[5]=l=>E(-90))}),u(j,{icon:"mdi-rotate-right",variant:"text",onClick:e[6]||(e[6]=l=>E(90))}),u(j,{"prepend-icon":"mdi-reload",variant:"text",disabled:!n.value||f.value||!C.value,loading:f.value,onClick:O},{default:k(()=>e[21]||(e[21]=[L(" Reload stream ")])),_:1,__:[21]},8,["disabled","loading"])]),f.value?(c(),ee(Te,{key:0,"model-value":V.value,color:"white",height:"4",rounded:"",class:"mb-4"},null,8,["model-value"])):le("",!0),u(ze,{modelValue:T.value,"onUpdate:modelValue":e[7]||(e[7]=l=>T.value=l),variant:"accordion",class:"mt-6"},{default:k(()=>[u(Ee,{value:"debug",class:"bg-[#FFFFFF11]"},{default:k(()=>[u(Ue,{class:"text-white"},{default:k(()=>e[22]||(e[22]=[L("Debug console")])),_:1,__:[22]}),u(Be,{class:"pa-0"},{default:k(()=>[M.value?(c(),ee(Ze,{key:0,"stream-id":M.value},null,8,["stream-id"])):(c(),m("div",ct,"Select a stream to view debug logs."))]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["style"])]),_:1},8,["modelValue","width"])],64))}}),ft=ne(vt,[["__scopeId","data-v-15e25947"]]);export{ft as default};
