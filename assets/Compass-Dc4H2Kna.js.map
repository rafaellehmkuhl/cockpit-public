{"version":3,"file":"Compass-Dc4H2Kna.js","sources":["../../src/components/Dialog.vue","../../src/components/widgets/Compass.vue"],"sourcesContent":["<template>\n  <teleport to=\"body\">\n    <dialog ref=\"dialogRef\" class=\"modal\">\n      <div\n        ref=\"dialogContentRef\"\n        v-bind=\"$attrs\"\n        class=\"flex flex-col items-center justify-center w-full h-full p-5 backdrop-blur-sm\"\n      >\n        <slot></slot>\n      </div>\n    </dialog>\n  </teleport>\n</template>\n\n<script setup lang=\"ts\">\nimport { onMounted, ref, toRefs, watch } from 'vue'\n\nconst props = defineProps({\n  show: Boolean,\n})\nconst emit = defineEmits(['update:show'])\n\nconst showProp = toRefs(props).show\nconst show = ref(showProp.value)\nconst dialogRef = ref()\nconst dialogContentRef = ref()\n\nonMounted(() => {\n  dialogRef.value.addEventListener('click', (e: MouseEvent) => {\n    if (\n      !e.target ||\n      (e.target instanceof HTMLElement && !e.target.closest('.action-button') && e.target.nodeName !== 'DIALOG')\n    )\n      return\n    // Close the dialog if the dialog (backdrop) or any element with the class 'action-button' was clicked\n    show.value = false\n  })\n  document.addEventListener(\n    'keydown',\n    (e: KeyboardEvent) => {\n      // In case ESC key was pressed blocks the event propagation to avoid default dialog 'cancel' event\n      if (show.value && e.key === 'Escape') {\n        e.preventDefault()\n        e.stopImmediatePropagation()\n        show.value = false\n      }\n    },\n    { passive: false }\n  )\n})\n\nwatch(showProp, () => (show.value = showProp.value))\nwatch(show, () => {\n  if (show.value) {\n    dialogRef.value.showModal()\n  } else {\n    dialogRef.value.setAttribute('closing', '')\n    dialogRef.value.addEventListener(\n      'animationend',\n      () => {\n        dialogRef.value.removeAttribute('closing')\n        dialogRef.value.close()\n      },\n      { once: true }\n    )\n  }\n  emit('update:show', show.value)\n})\n</script>\n\n<style>\n.modal {\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  margin-right: -50%;\n  transform: translate(-50%, -50%);\n  height: fit-content;\n  background-color: rgba(71, 85, 105, 0.3);\n  backdrop-filter: blur(1px);\n  box-shadow: 0 0 20px 5px rgba(0, 0, 0, 0.25);\n  border-radius: 5px;\n}\n.modal::backdrop {\n  background-color: rgba(0, 0, 0, 0.3);\n  opacity: 0;\n}\n.modal[open] {\n  animation: slide-in 250ms forwards, fade-in 250ms forwards;\n}\n.modal[open]::backdrop {\n  animation: fade-in 250ms forwards;\n}\n.modal[closing] {\n  pointer-events: none;\n  animation: fade-out 250ms forwards;\n}\n.modal[closing]::backdrop {\n  animation: fade-out 250ms forwards;\n}\n\n@keyframes slide-in {\n  0% {\n    top: 70%;\n  }\n  100% {\n    top: 50%;\n  }\n}\n@keyframes fade-in {\n  0% {\n    opacity: 0;\n  }\n  100% {\n    opacity: 1;\n  }\n}\n@keyframes fade-out {\n  100% {\n    opacity: 0;\n  }\n  0% {\n    opacity: 1;\n  }\n}\n</style>\n","<template>\n  <div ref=\"compassRoot\" class=\"compass\">\n    <canvas\n      ref=\"canvasRef\"\n      :height=\"smallestDimension\"\n      :width=\"smallestDimension\"\n      class=\"rounded-[15%] bg-slate-950/70\"\n    ></canvas>\n  </div>\n  <Dialog\n    v-model:show=\"widgetStore.widgetManagerVars(widget.hash).configMenuOpen\"\n    class=\"flex pa-4 bg-[#ffffff10] text-white backdrop-blur-2xl border-[1px] border-[#FAFAFA12]\"\n  >\n    <div class=\"flex items-center\">\n      <span class=\"mr-3 text-slate-100\">Heading style</span>\n      <div class=\"w-40\"><Dropdown v-model=\"widget.options.headingStyle\" :options=\"headingOptions\" /></div>\n    </div>\n  </Dialog>\n</template>\n\n<script setup lang=\"ts\">\nimport { useWindowSize } from '@vueuse/core'\nimport gsap from 'gsap'\nimport { computed, nextTick, onBeforeMount, onMounted, reactive, ref, toRefs, watch } from 'vue'\n\nimport Dialog from '@/components/Dialog.vue'\nimport Dropdown from '@/components/Dropdown.vue'\nimport { datalogger, DatalogVariable } from '@/libs/sensors-logging'\nimport { degrees, radians, resetCanvas, sequentialArray } from '@/libs/utils'\nimport { useMainVehicleStore } from '@/stores/mainVehicle'\nimport { useWidgetManagerStore } from '@/stores/widgetManager'\nimport type { Widget } from '@/types/widgets'\n\nconst widgetStore = useWidgetManagerStore()\n\ndatalogger.registerUsage(DatalogVariable.heading)\nconst store = useMainVehicleStore()\nconst compassRoot = ref()\nconst canvasRef = ref<HTMLCanvasElement | undefined>()\nconst canvasContext = ref()\n\n// Angles used for the main marks\nconst mainAngles = {\n  [0]: 'N',\n  [45]: 'NE',\n  [90]: 'E',\n  [135]: 'SE',\n  [180]: 'S',\n  [225]: 'SW',\n  [270]: 'W',\n  [315]: 'NW',\n}\n\n/**\n * Possible compass configurations.\n * North-up keeps the cardinal points fixed, while the vehicle rotates.\n * Head-up keeps the vehicle pointing up, while the cardinal points rotate.\n */\nenum HeadingStyle {\n  NORTH_UP = 'North Up',\n  HEAD_UP = 'Head Up',\n}\nconst headingOptions = Object.values(HeadingStyle)\n\nconst props = defineProps<{\n  /**\n   * Widget reference\n   */\n  widget: Widget\n}>()\nconst widget = toRefs(props).widget\n\nonBeforeMount(() => {\n  // Set initial widget options if they don't exist\n  if (Object.keys(widget.value.options).length === 0) {\n    widget.value.options = {\n      headingStyle: headingOptions[0],\n    }\n  }\n})\n\nonMounted(() => {\n  // Set initial value to 0.01 since 0.0 and 360 does not render anything\n  adjustLinesX()\n  renderCanvas()\n})\n\n// Make canvas size follows window resizing\nconst { width: windowWidth, height: windowHeight } = useWindowSize()\nconst width = computed(() => widget.value.size.width * windowWidth.value)\nconst height = computed(() => widget.value.size.height * windowHeight.value)\n\n// Calculates the smallest between the widget dimensions, so we can keep the inner content always inside it, without overlays\nconst smallestDimension = computed(() => (width.value < height.value ? width.value : height.value))\n\n// Renders the updated canvas state\nconst renderCanvas = (): void => {\n  if (canvasRef.value === undefined || canvasRef.value === null) return\n  if (canvasContext.value === undefined) canvasContext.value = canvasRef.value.getContext('2d')\n\n  const ctx = canvasContext.value\n  resetCanvas(ctx)\n\n  const halfCanvasSize = 0.5 * smallestDimension.value\n\n  // Set canvas general properties\n  const fontSize = 0.13 * smallestDimension.value\n  const baseLineWidth = 0.03 * halfCanvasSize\n\n  ctx.textAlign = 'center'\n  ctx.strokeStyle = 'white'\n  ctx.font = `bold ${fontSize}px Arial`\n  ctx.fillStyle = 'white'\n  ctx.lineWidth = baseLineWidth\n  ctx.textBaseline = 'middle'\n\n  const outerCircleRadius = 0.7 * halfCanvasSize\n  const innerIndicatorRadius = 0.4 * halfCanvasSize\n  const outerIndicatorRadius = 0.55 * halfCanvasSize\n\n  // Start drawing from the center\n  ctx.translate(halfCanvasSize, halfCanvasSize)\n\n  // Draw central angle text\n  ctx.font = `bold ${fontSize}px Arial`\n  ctx.fillText(`${renderVariables.yawAngleDegrees.toFixed(0)}Â°`, 0.15 * fontSize, 0)\n\n  // Set 0 degrees on the top position\n  ctx.rotate(radians(-90))\n\n  // Draw line and identification for each cardinal and sub-cardinal angle\n  if (widget.value.options.headingStyle == HeadingStyle.HEAD_UP) {\n    ctx.rotate(-radians(renderVariables.yawAngleDegrees))\n  }\n  for (const [angleDegrees, angleName] of Object.entries(mainAngles)) {\n    ctx.save()\n\n    ctx.rotate(radians(Number(angleDegrees)))\n    ctx.beginPath()\n    ctx.moveTo(outerIndicatorRadius, 0)\n    ctx.lineTo(outerCircleRadius, 0)\n\n    // Draw angle text\n    ctx.textBaseline = 'bottom'\n    ctx.font = `bold ${0.7 * fontSize}px Arial`\n    ctx.translate(outerCircleRadius * 1.025, 0)\n    ctx.rotate(radians(90))\n    ctx.fillText(angleName, 0, 0)\n\n    ctx.stroke()\n    ctx.restore()\n  }\n\n  // Draw line for each smaller angle, with 9 degree steps\n  for (const angleDegrees of sequentialArray(360)) {\n    if (angleDegrees % 9 !== 0) continue\n    ctx.save()\n    ctx.lineWidth = 0.25 * baseLineWidth\n    ctx.rotate(radians(Number(angleDegrees)))\n    ctx.beginPath()\n    ctx.moveTo(1.1 * outerIndicatorRadius, 0)\n    ctx.lineTo(outerCircleRadius, 0)\n    ctx.stroke()\n    ctx.restore()\n  }\n\n  // Draw outer circle\n  ctx.beginPath()\n  ctx.arc(0, 0, outerCircleRadius, 0, radians(360))\n  ctx.stroke()\n\n  // Draw central indicator\n  if (widget.value.options.headingStyle == HeadingStyle.NORTH_UP) {\n    ctx.rotate(radians(renderVariables.yawAngleDegrees))\n  } else {\n    ctx.rotate(radians(renderVariables.yawAngleDegrees))\n  }\n  ctx.beginPath()\n  ctx.lineWidth = 1\n  ctx.strokeStyle = 'red'\n  ctx.fillStyle = 'red'\n  const triangleBaseSize = 0.05 * halfCanvasSize\n  ctx.moveTo(innerIndicatorRadius, triangleBaseSize)\n  ctx.lineTo(outerIndicatorRadius - 0.5 * triangleBaseSize, 0)\n  ctx.lineTo(innerIndicatorRadius, -triangleBaseSize)\n  ctx.lineTo(innerIndicatorRadius, triangleBaseSize)\n  ctx.closePath()\n  ctx.fill()\n  ctx.stroke()\n}\n\n/**\n * Deal with high frequency update and decrease cpu usage when drawing low degrees changes\n */\n\nconst yaw = ref(0.01)\nlet oldYaw: number | undefined = undefined\nwatch(store.attitude, (attitude) => {\n  if (oldYaw === undefined) {\n    yaw.value = degrees(store.attitude.yaw)\n    oldYaw = attitude.yaw\n    return\n  }\n  const yawDiff = Math.abs(degrees(attitude.yaw - oldYaw))\n  if (yawDiff > 0.1) {\n    oldYaw = attitude.yaw\n    yaw.value = degrees(store.attitude.yaw)\n  }\n})\n\n// eslint-disable-next-line jsdoc/require-jsdoc\ntype RenderVariables = { yawAngleDegrees: number }\n// Object used to store current render state\nconst renderVariables = reactive<RenderVariables>({ yawAngleDegrees: 0 })\n\n// Update the X position of each line in the render variables with GSAP to smooth the transition\nconst adjustLinesX = (): void => {\n  const angleDegrees = yaw.value\n\n  const fullRangeAngleDegrees = angleDegrees < 0 ? angleDegrees + 360 : angleDegrees\n\n  const fromWestToEast = renderVariables.yawAngleDegrees > 270 && fullRangeAngleDegrees < 90\n  const fromEastToWest = renderVariables.yawAngleDegrees < 90 && fullRangeAngleDegrees > 270\n  // If cruzing 0 degrees, use a chained animation, so the pointer does not turn 360 degrees to the other side (visual artifact)\n  if (fromWestToEast) {\n    gsap.to(renderVariables, 0.05, { yawAngleDegrees: 0 })\n    gsap.fromTo(renderVariables, 0.05, { yawAngleDegrees: 0 }, { yawAngleDegrees: fullRangeAngleDegrees })\n  } else if (fromEastToWest) {\n    gsap.to(renderVariables, 0.05, { yawAngleDegrees: 360 })\n    gsap.fromTo(renderVariables, 0.05, { yawAngleDegrees: 360 }, { yawAngleDegrees: fullRangeAngleDegrees })\n  } else {\n    gsap.to(renderVariables, 0.1, { yawAngleDegrees: fullRangeAngleDegrees })\n  }\n}\n\n// When the yaw changes, adjust the lines X position\nwatch(yaw, () => adjustLinesX())\n\n// Update canvas whenever reference variables changes\nwatch([renderVariables, width, height], () => {\n  if (!widgetStore.isWidgetVisible(widget.value)) return\n  nextTick(() => renderCanvas())\n})\n</script>\n\n<style scoped>\n.compass {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  width: 100%;\n  height: 100%;\n}\n</style>\n"],"names":["props","__props","emit","__emit","showProp","toRefs","show","ref","dialogRef","dialogContentRef","onMounted","e","watch","HeadingStyle","widgetStore","useWidgetManagerStore","datalogger","DatalogVariable","store","useMainVehicleStore","compassRoot","canvasRef","canvasContext","mainAngles","headingOptions","widget","onBeforeMount","adjustLinesX","renderCanvas","windowWidth","windowHeight","useWindowSize","width","computed","height","smallestDimension","ctx","resetCanvas","halfCanvasSize","fontSize","baseLineWidth","outerCircleRadius","innerIndicatorRadius","outerIndicatorRadius","renderVariables","radians","angleDegrees","angleName","sequentialArray","triangleBaseSize","yaw","oldYaw","attitude","degrees","reactive","fullRangeAngleDegrees","fromWestToEast","fromEastToWest","gsap","nextTick"],"mappings":"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"}