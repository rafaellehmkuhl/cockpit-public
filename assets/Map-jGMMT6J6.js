import{bF as Oe,bG as $e,bH as Re,bI as We,bJ as ee,f as Xe,bK as Ie,bL as Ye,bM as Ze,c as Ge,bv as je,J as qe,K as Je,a8 as Ke,u as Qe,ak as et,r as f,k as y,M as Ee,Y as Ve,L as tt,bN as s,j as at,w as g,o as ot,bO as h,ae as nt,bP as it,aJ as lt,bQ as st,bR as Le,aG as rt,y as ut,aN as ct,l as O,m as ce,n as z,H as w,N as $,I as X,a6 as te,a0 as ae,q as r,au as H,s as N,a1 as oe,v as dt,O as ne,V as vt,P as mt,Q as ft,R as pt,a5 as gt,W as ht,bS as bt,bT as kt,F as Mt,bU as Y,_ as xt}from"./index-COF5PWnB.js";function yt(T){return Oe({},T)}var Se=1440,wt=2520,de=43200,Tt=86400;function Ct(T,L,u){var F,_;$e(2,arguments);var i=Ze(),n=(F=(_=u==null?void 0:u.locale)!==null&&_!==void 0?_:i.locale)!==null&&F!==void 0?F:Re;if(!n.formatDistance)throw new RangeError("locale must contain formatDistance property");var a=We(T,L);if(isNaN(a))throw new RangeError("Invalid time value");var l=Oe(yt(u),{addSuffix:!!(u!=null&&u.addSuffix),comparison:a}),b,p;a>0?(b=ee(L),p=ee(T)):(b=ee(T),p=ee(L));var C=Xe(p,b),I=(Ie(p)-Ie(b))/1e3,c=Math.round((C-I)/60),v;if(c<2)return u!=null&&u.includeSeconds?C<5?n.formatDistance("lessThanXSeconds",5,l):C<10?n.formatDistance("lessThanXSeconds",10,l):C<20?n.formatDistance("lessThanXSeconds",20,l):C<40?n.formatDistance("halfAMinute",0,l):C<60?n.formatDistance("lessThanXMinutes",1,l):n.formatDistance("xMinutes",1,l):c===0?n.formatDistance("lessThanXMinutes",1,l):n.formatDistance("xMinutes",c,l);if(c<45)return n.formatDistance("xMinutes",c,l);if(c<90)return n.formatDistance("aboutXHours",1,l);if(c<Se){var Z=Math.round(c/60);return n.formatDistance("aboutXHours",Z,l)}else{if(c<wt)return n.formatDistance("xDays",1,l);if(c<de){var G=Math.round(c/Se);return n.formatDistance("xDays",G,l)}else if(c<Tt)return v=Math.round(c/de),n.formatDistance("aboutXMonths",v,l)}if(v=Ye(p,b),v<12){var j=Math.round(c/de);return n.formatDistance("xMonths",j,l)}else{var B=v%12,U=Math.floor(v/12);return B<3?n.formatDistance("aboutXYears",U,l):B<9?n.formatDistance("overXYears",U,l):n.formatDistance("almostXYears",U+1,l)}}function It(T,L){return $e(1,arguments),Ct(T,Date.now(),L)}const Et=""+new URL("blueboat-marker-DyHmCFOq.png",import.meta.url).href,Vt=""+new URL("brov2-marker-CBzp11FX.png",import.meta.url).href,Lt=""+new URL("generic-vehicle-marker-SovxT5Tc.png",import.meta.url).href,St=["id"],Ot=Ge({__name:"Map",props:{widget:{}},setup(T){var Ce;je(e=>({"385a51bc":Ae.value}));const L=T,u=qe(L).widget,F=Je(),{showDialog:_}=Ke(),i=Qe(),n=et(),a=f(),l=f(n.defaultMapZoom),b=f(n.defaultMapCenter),p=f(),C=y(()=>`map-${u.value.hash}`),I=f(!1),c=f(null),v=f({});Ee.registerUsage(Ve.latitude),Ee.registerUsage(Ve.longitude),tt(()=>{Object.keys(u.value.options).length===0&&(u.value.options={showVehiclePath:!0}),k.enableAutoUpdate()});const Z=s.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:23,maxNativeZoom:19,attribution:"© OpenStreetMap"}),G=s.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:23,maxNativeZoom:19,attribution:"© Esri World Imagery"}),j=s.tileLayer("https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png",{maxZoom:18,attribution:"© OpenSeaMap contributors"}),B=s.tileLayer.wms("https://geoserver.openseamap.org/geoserver/gwc/service/wms",{layers:"gebco2021:gebco_2021",format:"image/png",transparent:!0,version:"1.1.1",attribution:"© GEBCO, OpenSeaMap",tileSize:256,maxZoom:19}),U={OpenStreetMap:Z,"Esri World Imagery":G},De={Seamarks:j,"Marine Profile":B},ve=f(),me=at(ve),fe=s.control.zoom({position:"bottomright"}),pe=s.control.layers(U,De);g(I,()=>{a.value!==void 0&&(I.value?(a.value.addControl(fe),a.value.addControl(pe)):(a.value.removeControl(fe),a.value.removeControl(pe)))}),g(me,()=>{I.value=me.value}),ot(async()=>{a.value=s.map(C.value,{layers:[Z,G,j,B],attributionControl:!1}).setView(b.value,l.value),a.value.removeControl(a.value.zoomControl),a.value.on("moveend",()=>{if(a.value===void 0)return;let{lat:e,lng:t}=a.value.getCenter();e&&t&&(b.value=[e,t])}),a.value.on("zoomend",()=>{var e;a.value!==void 0&&(l.value=((e=a.value)==null?void 0:e.getZoom())??b.value)}),a.value.on("click",()=>{a.value!==void 0&&a.value.on("click",be)}),a.value.on("contextmenu",()=>{ke()}),k.enableAutoUpdate(),window.addEventListener("keydown",Me),M.value?k.goToTarget(h.VEHICLE):k.goToTarget(h.HOME)}),nt(()=>{k.disableAutoUpdate(),window.removeEventListener("keydown",Me),a.value&&(a.value.off("click",be),a.value.off("contextmenu"),Object.values(v.value).forEach(e=>e.remove()),v.value={})}),g(b,(e,t)=>{var o,d,x;e.toString()!==t.toString()&&((o=a.value)==null||o.panTo(e),(x=(d=D.value)==null?void 0:d.getTooltip())==null||x.setContent(`Home: ${e[0].toFixed(6)}, ${e[1].toFixed(6)}`))}),g(a,(e,t)=>{a.value!==void 0&&(e==null?void 0:e.options)===void 0&&(a.value=t)}),g(l,(e,t)=>{var o;e!==t&&((o=a.value)==null||o.setZoom(l.value))}),g(L.widget,()=>{var e;(e=a.value)==null||e.invalidateSize()});const A=f(void 0),k=new it(e=>A.value=e,e=>b.value=e);k.setTrackableTarget(h.VEHICLE,()=>M.value),k.setTrackableTarget(h.HOME,()=>p.value);const M=y(()=>i.coordinates.latitude?[i.coordinates.latitude,i.coordinates.longitude]:void 0),ie=y(()=>{var e;return i.attitude.yaw?lt((e=i.attitude)==null?void 0:e.yaw):0}),ge=y(()=>{const e=i.lastHeartbeat;return e?`${It(e??0,{includeSeconds:!0})} ago`:"never"}),{history:Pe}=st(M);(Ce=navigator==null?void 0:navigator.geolocation)==null||Ce.watchPosition(e=>p.value=[e.coords.latitude,e.coords.longitude],e=>console.error(`Failed to get position: (${e.code}) ${e.message}`),{enableHighAccuracy:!1,timeout:5e3,maximumAge:0});let he=!0;g([p,a],async()=>{p.value===b.value||!a.value||!he||(k.goToTarget(h.HOME),he=!1)});const S=f();g(i.coordinates,()=>{if(!(!a.value||!M.value)){if(S.value===void 0){let e=Lt;i.vehicleType===Le.MAV_TYPE_SURFACE_BOAT?e=Et:i.vehicleType===Le.MAV_TYPE_SUBMARINE&&(e=Vt);const t=s.divIcon({className:"vehicle-marker",html:`<img src="${e}" style="width: 64px; height: 64px;">`,iconSize:[64,64],iconAnchor:[32,32]});S.value=s.marker(M.value,{icon:t});const o=s.tooltip({content:"No data available",className:"waypoint-tooltip",offset:[40,0]});S.value.bindTooltip(o),a.value.addLayer(S.value)}S.value.setLatLng(M.value)}}),g(M,(e,t)=>{A.value===h.VEHICLE||t!==void 0||k.follow(h.VEHICLE)}),g([M,ie,ge,()=>i.isArmed],()=>{var t,o,d,x,m;if(S.value===void 0)return;(x=S.value.getTooltip())==null||x.setContent(`
    <p>Coordinates: ${(t=M.value)==null?void 0:t[0].toFixed(6)}, ${(o=M.value)==null?void 0:o[1].toFixed(6)}</p>
    <p>Velocity: ${((d=i.velocity.ground)==null?void 0:d.toFixed(2))??"N/A"} m/s</p>
    <p>Heading: ${ie.value.toFixed(2)}°</p>
    <p>${i.isArmed?"Armed":"Disarmed"}</p>
    <p>Last seen: ${ge.value}</p>
  `);const e=(m=S.value.getElement())==null?void 0:m.querySelector("img");e&&(e.style.transform=`rotate(${ie.value}deg)`)});const D=f();g(p,()=>{if(a.value===void 0)return;const e=p.value;if(e!==void 0){if(D.value===void 0){D.value=s.marker(e);const t=s.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16],html:"H"});D.value.setIcon(t);const o=s.tooltip({content:"No data available",className:"waypoint-tooltip"});D.value.bindTooltip(o),a.value.addLayer(D.value)}D.value.setLatLng(p.value)}});const le=f();g(n.currentPlanningWaypoints,e=>{if(a.value!==void 0){if(le.value===void 0){const t=e.map(o=>o.coordinates);le.value=s.polyline(t,{color:"#358AC3"}).addTo(a.value)}le.value.setLatLngs(e.map(t=>t.coordinates)),e.forEach((t,o)=>{var m;const d=s.marker(t.coordinates),x=s.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16],html:`${o}`});d.setIcon(x),(m=a.value)==null||m.addLayer(d)})}});const se=f();g(Pe,e=>{if(a.value===void 0||e===void 0)return;se.value===void 0&&(se.value=s.polyline([],{color:"#ffff00"}).addTo(a.value));const t=e.filter(o=>o.snapshot!==void 0).map(o=>o.snapshot);se.value.setLatLngs(t)});const q=f(!1),E=f(null),J=rt({top:"0px",left:"0px"}),P=f(),be=e=>{var t,o,d,x;if(P.value!==void 0&&a.value!==void 0&&((t=P.value)==null||t.removeFrom(a.value)),((o=e==null?void 0:e.latlng)==null?void 0:o.lat)!=null&&((d=e==null?void 0:e.latlng)==null?void 0:d.lng)!=null){E.value=[e.latlng.lat,e.latlng.lng],q.value=!0;const m=(x=a.value)==null?void 0:x.getContainer();if(m){const{x:V,y:W}=m.getBoundingClientRect();J.left=`${e.originalEvent.clientX-V}px`,J.top=`${e.originalEvent.clientY-W}px`}}else console.error("Invalid event structure:",e);if(a.value!==void 0){P.value=s.marker(E.value);const m=s.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16]});P.value.setIcon(m),a.value.addLayer(P.value)}},re=async e=>{switch(e){case"goto":if(E.value){const m=i.coordinates.altitude??0,V=E.value[0],W=E.value[1];try{await i.goTo(0,0,0,0,V,W,m)}catch(Q){Y({message:`GoTo request failed: ${Q.message}`,variant:"error"})}}break;case"set-default-map-position":n.setDefaultMapPosition(b.value,l.value);break;case"place-poi":E.value&&c.value?c.value.openDialog(E.value):E.value?c.value||(Y({message:"POI Manager (map widget) is not available.",variant:"error"}),console.error("Cannot open POI dialog, POI Manager (map widget) ref is not set.")):(Y({message:"Cannot place Point of Interest without map coordinates.",variant:"error"}),console.error("Cannot open POI dialog without click coordinates for new POI"));break;default:console.warn("Unknown menu option selected:",e)}q.value=!1},ke=()=>{q.value=!1,E.value=null,a.value!==void 0&&P.value!==void 0&&a.value.removeLayer(P.value)},Me=e=>{e.key==="Escape"&&ke()},K=f(!1),ue=f(0),He=async()=>{for(K.value=!0,ue.value=0;n.currentPlanningWaypoints.length>0;)n.currentPlanningWaypoints.pop();const e=async t=>{ue.value=t};try{(await i.fetchMission(e)).forEach(o=>{n.currentPlanningWaypoints.push(o)}),Y({variant:"success",message:"Mission download succeed!",duration:3e3})}catch(t){_({variant:"error",title:"Mission download failed",message:t,timer:5e3})}finally{K.value=!1}},Ne=async()=>{try{await i.startMission()}catch{Y({message:"Failed to start mission.",variant:"error"})}},R=ut(),Ae=y(()=>`${Math.max(-R.widgetClearanceForVisibleArea(u.value).bottom,0)}px`),xe=y(()=>`${Math.max(-R.widgetClearanceForVisibleArea(u.value).top,0)}px`),ze=y(()=>i.isVehicleOnline?"Download the mission that is stored in the vehicle.":"Cannot download mission (vehicle offline)."),Fe=y(()=>i.isVehicleOnline?"Execute the mission that is stored in the vehicle.":"Cannot execute mission (vehicle offline)."),_e=y(()=>p.value===void 0?"Cannot center map on home (home position undefined).":A.value===h.HOME?"Tracking home position. Click to stop tracking.":"Click once to center on home or twice to track it."),Be=y(()=>i.isVehicleOnline?M.value===void 0?"Cannot center map on vehicle (vehicle position undefined).":A.value===h.VEHICLE?"Tracking vehicle position. Click to stop tracking.":"Click once to center on vehicle or twice to track it.":"Cannot center map on vehicle (vehicle offline)."),ye=e=>({html:`
    <div class="poi-marker-container">
      <div class="poi-marker-background" style="background-color: ${e.color}80;"></div>
      <i class="v-icon notranslate mdi ${e.icon}" style="color: rgba(255, 255, 255, 0.7); position: relative; z-index: 2;"></i>
    </div>
  `,className:"poi-marker-icon-widget",iconSize:[60,60],iconAnchor:[30,60]}),we=e=>{if(!a.value||!a.value.getContainer())return;const t=s.divIcon(ye(e)),o=s.marker(e.coordinates,{icon:t,draggable:!0}).addTo(a.value),d=`
    <strong>${e.name}</strong><br>
    ${e.description?e.description+"<br>":""}
    Lat: ${e.coordinates[0].toFixed(8)}, Lng: ${e.coordinates[1].toFixed(8)}
  `,x={permanent:!1,direction:"top",offset:[-14,-64],className:"poi-tooltip-widget"};o.bindTooltip(d,x),o.on("drag",m=>{var Q;const V=m.target.getLatLng(),W=`
      <strong>${e.name}</strong><br>
      ${e.description?e.description+"<br>":""}
      Lat: ${V.lat.toFixed(8)}, Lng: ${V.lng.toFixed(8)}
    `;(Q=o.getTooltip())==null||Q.setContent(W)}),o.on("dragend",m=>{const V=m.target.getLatLng();n.movePointOfInterest(e.id,[V.lat,V.lng])}),o.on("click",m=>{s.DomEvent.stopPropagation(m),c.value&&c.value.openDialog(void 0,e)}),v.value[e.id]=o},Te=e=>{var d;if(!a.value||!a.value.getContainer()||!v.value[e.id])return;const t=v.value[e.id];t.setLatLng(e.coordinates),t.setIcon(s.divIcon(ye(e)));const o=`
    <strong>${e.name}</strong><br>
    ${e.description?e.description+"<br>":""}
    Lat: ${e.coordinates[0].toFixed(8)}, Lng: ${e.coordinates[1].toFixed(8)}
  `;(d=t.getTooltip())==null||d.setContent(o)},Ue=e=>{!a.value||!v.value[e]||(v.value[e].remove(),delete v.value[e])};return g(()=>n.pointsOfInterest,async e=>{if((!a.value||!a.value.getContainer())&&(await ct(),!a.value||!a.value.getContainer())){console.warn("Map.vue: POI watcher - map not ready after nextTick.");return}const t=new Set(e.map(o=>o.id));Object.keys(v.value).forEach(o=>{t.has(o)||Ue(o)}),e.forEach(o=>{v.value[o.id]?Te(o):we(o)})},{deep:!0,immediate:!0}),g(a,e=>{e&&e.getContainer()&&n.pointsOfInterest.forEach(t=>{v.value[t.id]?Te(t):we(t)})},{immediate:!0}),(e,t)=>(O(),ce(Mt,null,[z("div",{ref_key:"mapBase",ref:ve,class:dt(["page-base",r(R).editingMode?"pointer-events-none":"pointer-events-auto"])},[z("div",{id:C.value,ref_key:"map",ref:a,class:"map"},[w(oe,{location:"top",text:_e.value},{activator:$(({props:o})=>[I.value?(O(),X(te,ae({key:0},o,{class:["absolute right-[166px] m-3 bottom-button bg-slate-50",p.value?"":"active-events-on-disabled"],color:A.value==r(h).HOME?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-home-map-marker",size:"x-small",disabled:!p.value,onClick:t[0]||(t[0]=H(d=>r(k).goToTarget(r(h).HOME,!0),["stop"])),onDblclick:t[1]||(t[1]=H(d=>r(k).follow(r(h).HOME),["stop"]))}),null,16,["class","color","disabled"])):N("",!0)]),_:1},8,["text"]),w(oe,{location:"top",text:Be.value},{activator:$(({props:o})=>[I.value?(O(),X(te,ae({key:0},o,{class:["absolute m-3 bottom-button right-[124px] bg-slate-50",M.value?"":"active-events-on-disabled"],color:A.value==r(h).VEHICLE?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-airplane-marker",size:"x-small",disabled:!M.value,onClick:t[2]||(t[2]=H(d=>r(k).goToTarget(r(h).VEHICLE,!0),["stop"])),onDblclick:t[3]||(t[3]=H(d=>r(k).follow(r(h).VEHICLE),["stop"]))}),null,16,["class","color","disabled"])):N("",!0)]),_:1},8,["text"]),w(oe,{location:"top",text:ze.value},{activator:$(({props:o})=>[I.value?(O(),X(te,ae({key:0},o,{class:["absolute m-3 bottom-button right-[82px] bg-slate-50",r(i).isVehicleOnline?"":"active-events-on-disabled"],disabled:!r(i).isVehicleOnline,elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-download",size:"x-small",onClick:H(He,["stop"])}),null,16,["class","disabled"])):N("",!0)]),_:1},8,["text"]),w(oe,{location:"top",text:Fe.value},{activator:$(({props:o})=>[I.value?(O(),X(te,ae({key:0},o,{class:["absolute mb-3 ml-1 bottom-button right-[52px] bg-slate-50",r(i).isVehicleOnline?"":"active-events-on-disabled"],disabled:!r(i).isVehicleOnline,elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-play",size:"x-small",onClick:H(Ne,["stop"])}),null,16,["class","disabled"])):N("",!0)]),_:1},8,["text"])],8,St)],2),q.value?(O(),ce("div",{key:0,class:"context-menu",style:ne({top:J.top,left:J.left})},[z("ul",{onClick:t[7]||(t[7]=H(()=>{},["stop"]))},[z("li",{onClick:t[4]||(t[4]=o=>re("goto"))},"GoTo"),z("li",{onClick:t[5]||(t[5]=o=>re("set-default-map-position"))},"Set default map position"),z("li",{onClick:t[6]||(t[6]=o=>re("place-poi"))},"Place point of interest")])],4)):N("",!0),w(ht,{modelValue:r(R).widgetManagerVars(r(u).hash).configMenuOpen,"onUpdate:modelValue":t[9]||(t[9]=o=>r(R).widgetManagerVars(r(u).hash).configMenuOpen=o),width:"auto"},{default:$(()=>[w(vt,{class:"pa-2",style:ne(r(F).globalGlassMenuStyles)},{default:$(()=>[w(mt,{class:"text-center"},{default:$(()=>t[10]||(t[10]=[ft("Map widget settings")])),_:1}),w(pt,null,{default:$(()=>[w(gt,{modelValue:r(u).options.showVehiclePath,"onUpdate:modelValue":t[8]||(t[8]=o=>r(u).options.showVehiclePath=o),class:"my-1",label:"Show vehicle path",color:r(u).options.showVehiclePath?"white":void 0,"hide-details":""},null,8,["modelValue","color"])]),_:1})]),_:1},8,["style"])]),_:1},8,["modelValue"]),K.value?(O(),X(bt,{key:1,"model-value":ue.value,height:"10",absolute:"",bottom:"",color:"white",style:ne(`top: ${xe.value}`)},null,8,["model-value","style"])):N("",!0),K.value?(O(),ce("p",{key:2,style:ne({top:xe.value}),class:"absolute left-[7px] mt-4 flex text-md font-bold text-white z-30 drop-shadow-md"}," Loading mission... ",4)):N("",!0),w(kt,{ref_key:"poiManagerMapWidgetRef",ref:c},null,512)],64))}}),Dt=xt(Ot,[["__scopeId","data-v-6cc1050e"]]);export{Dt as default};
