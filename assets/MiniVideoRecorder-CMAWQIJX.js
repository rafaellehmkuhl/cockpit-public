import{c as X,af as Z,K as ee,y as te,ag as ae,J as oe,r as g,ah as se,ai as ne,e as ie,k as F,w as S,o as re,L as le,aj as ue,ak as de,al as ce,D as ve,l as h,m as l,n as c,H as x,s as L,x as P,v as i,F as z,I as V,t as U,am as me,O as f,a6 as I,Q as k,an as ge,N as fe,ao as pe,a7 as q,W as ye,ap as Se,_ as xe}from"./index-BTFN8mwM.js";const he={class:"text-xs text-white select-none scroll-text"},be={key:1,class:"w-16 text-justify text-slate-100"},we={class:"flex justify-center w-6"},Ve={class:"flex w-full justify-between items-center mt-4"},ke={key:1,class:"w-5 h-5 ml-2 rounded-full bg-red"},Me=X({__name:"MiniVideoRecorder",props:{miniWidget:{}},setup(H){const{showDialog:p}=Z(),M=ee(),v=te(),s=ae(),o=oe(H).miniWidget,a=g(),{namessAvailableAbstractedStreams:b}=se(s),R=g(),{isOutside:N}=ne(R),W=g(!1),y=g(!1),G=ie({interval:100}),u=g(),C=g(0),n=g(),w=F(()=>n.value),_=()=>{M.videoLibraryMode="videos",M.videoLibraryVisibility=!0};S(()=>s.streamsCorrespondency,()=>u.value=void 0,{deep:!0}),re(async()=>{await O()}),le(async()=>{Object.keys(o.value.options).length===0&&(o.value.options={internalStreamName:void 0}),a.value=o.value.options.internalStreamName,a.value&&(n.value=s.externalStreamId(a.value))}),S(a,()=>{o.value.options.internalStreamName=a.value,u.value=void 0}),S(()=>s.streamsCorrespondency,t=>{if(!n.value)return;const e=t.find(r=>r.externalId===n.value);e?a.value!==e.name&&(a.value=e.name):(a.value=void 0,n.value=void 0)},{deep:!0}),S(a,t=>{n.value=t?s.externalStreamId(t):void 0,o.value.options.internalStreamName=t,u.value=void 0});const O=async()=>{const e=(await s.videoStorage.keys()).filter(r=>s.isVideoFilename(r)).length;C.value=e};function D(t){if(a.value=t,a.value===void 0){p({message:"No stream selected.",variant:"error"});return}if(b.value.includes(a.value))return;const e="The selected stream is not available. Please check its source or select another stream.";throw p({message:e,variant:"error"}),new Error(e)}const J=async()=>{if(m.value){n.value&&s.stopRecording(n.value);return}if(!a.value){v.miniWidgetManagerVars(o.value.hash).configMenuOpen=!0;return}B()},B=()=>{var t;if(!n.value){p({title:"Cannot start recording.",message:"No stream selected.",variant:"error"});return}if(!((t=s.getStreamData(n.value))!=null&&t.connected)){p({title:"Cannot start recording.",message:"Stream is not connected.",variant:"error"});return}D(a.value),s.startRecording(n.value),v.miniWidgetManagerVars(o.value.hash).configMenuOpen=!1},m=F(()=>n.value?s.isRecording(n.value):!1),K=F(()=>{var A,j,T,E;if(w.value===void 0)return"00:00:00";const t=(A=s.getStreamData(w.value))==null?void 0:A.timeRecordingStart;if(t===void 0)return"00:00:00";const e=ue({start:t,end:G.value}),r=((j=e.hours)==null?void 0:j.toFixed(0).length)===1?`0${e.hours}`:e.hours,d=((T=e.minutes)==null?void 0:T.toFixed(0).length)===1?`0${e.minutes}`:e.minutes,Y=((E=e.seconds)==null?void 0:E.toFixed(0).length)===1?`0${e.seconds}`:e.seconds;return`${r}:${d}:${Y}`}),Q=async t=>{D(t),u.value=void 0,y.value=!0;let e=0;const r=100,d=3e3;for(;y.value&&e<d;)y.value=u.value===void 0||!u.value.active,await Se(r),e+=r;if(y.value){p({message:"Could not load media stream.",variant:"error"});return}o.value.options.internalStreamName=t};let $;return v.isRealMiniWidget(o.value.hash)&&($=setInterval(()=>{if(o.value.options.internalStreamName===void 0&&!b.value.isEmpty()&&(o.value.options.internalStreamName=b.value[0],a.value=o.value.options.internalStreamName),w.value!==void 0){const t=s.getMediaStream(w.value);de(t,u.value)||(u.value=t)}},1e3)),ce(()=>clearInterval($)),S(()=>W.value,async t=>{t===!1&&await O()}),S(m,()=>{if(!m.value){window.onbeforeunload=null;return}window.onbeforeunload=()=>(p({message:`
      You have a video recording ongoing.
      Remember to stop it before closing Cockpit, or the record will be lost.
    `,variant:"warning"}),"I hope the user does not click on the leave button.")}),(t,e)=>{const r=ve("FontAwesomeIcon");return l(),h(z,null,[c("div",{ref_key:"recorderWidget",ref:R,class:"flex justify-around px-2 py-1 text-center rounded-lg w-40 h-9 align-center bg-slate-800/60"},[c("div",{class:P([{"blob red w-5 opacity-100 rounded-sm":m.value,"opacity-30 bg-red-400":i(N)&&!m.value},"w-6 transition-all duration-500 rounded-full aspect-square bg-red-lighten-1 hover:cursor-pointer opacity-70 hover:opacity-90"]),onClick:e[0]||(e[0]=d=>J())},null,2),m.value?L("",!0):(l(),h(z,{key:0},[a.value?(l(),h("div",{key:0,class:"flex flex-col max-w-[50%] scroll-container transition-all border-blur cursor-pointer",onClick:e[1]||(e[1]=d=>i(v).miniWidgetManagerVars(i(o).hash).configMenuOpen=!0)},[c("div",he,U(a.value),1)])):(l(),V(r,{key:1,icon:"fa-solid fa-video",class:"h-6 text-slate-100"}))],64)),m.value?(l(),h("div",be,U(K.value),1)):L("",!0),c("div",we,[x(me,{vertical:"",class:"h-6 ml-1"}),C.value>0?(l(),V(ge,{key:0,color:"info",content:C.value,dot:i(N)||W.value,class:"cursor-pointer",onClick:_},{default:f(()=>[x(I,{class:"w-6 h-6 ml-1 text-slate-100",onClick:_},{default:f(()=>e[4]||(e[4]=[k(" mdi-video-box ")])),_:1,__:[4]})]),_:1},8,["content","dot"])):(l(),V(I,{key:1,class:"w-6 h-6 ml-1 text-slate-100 cursor-pointer",onClick:_},{default:f(()=>e[5]||(e[5]=[k(" mdi-video-box ")])),_:1,__:[5]}))])],512),x(ye,{modelValue:i(v).miniWidgetManagerVars(i(o).hash).configMenuOpen,"onUpdate:modelValue":e[3]||(e[3]=d=>i(v).miniWidgetManagerVars(i(o).hash).configMenuOpen=d),width:"auto"},{default:f(()=>[c("div",{class:"flex flex-col items-center p-2 pt-1 m-5 rounded-md gap-y-4",style:fe(i(M).globalGlassMenuStyles)},[e[9]||(e[9]=c("p",{class:"text-xl font-semibold m-4"},"Choose a stream to record",-1)),x(pe,{"model-value":a.value,label:"Stream name",items:i(b),"item-title":"name",density:"compact",variant:"outlined","no-data-text":"No streams available.","hide-details":"","return-object":"",theme:"dark",class:"w-[90%]","onUpdate:modelValue":Q},null,8,["model-value","items"]),c("div",Ve,[x(q,{class:"w-auto text-uppercase",variant:"text",onClick:e[2]||(e[2]=d=>i(v).miniWidgetManagerVars(i(o).hash).configMenuOpen=!1)},{default:f(()=>e[6]||(e[6]=[k(" Close ")])),_:1,__:[6]}),x(q,{class:P(["bg-[#FFFFFF11] hover:bg-[#FFFFFF33]",{"opacity-30 pointer-events-none":y.value}]),size:"large",onClick:B},{default:f(()=>[e[8]||(e[8]=c("span",null,"Record",-1)),y.value?(l(),V(I,{key:0,class:"m-2 animate-spin"},{default:f(()=>e[7]||(e[7]=[k("mdi-loading")])),_:1,__:[7]})):(l(),h("div",ke))]),_:1,__:[8]},8,["class"])])],4)]),_:1},8,["modelValue"])],64)}}}),Fe=xe(Me,[["__scopeId","data-v-ee955ba1"]]);export{Fe as default};
