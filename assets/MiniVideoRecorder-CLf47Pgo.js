import{c as Z,a7 as ee,K as te,y as ae,a8 as se,J as ne,r as v,a9 as oe,aa as ie,e as re,k as C,w as m,o as le,L as de,ab as ue,ac as ce,ad as ve,D as me,l as d,m as f,n as g,v as U,q as i,H as p,N as w,Q as M,ae as _,F as L,t as q,I as z,s as H,af as fe,ag as ge,O as pe,ah as ye,a5 as G,W as be,ai as he,_ as we}from"./index-BuIQHwnx.js";(function(){try{var y=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},u=new y.Error().stack;u&&(y._sentryDebugIds=y._sentryDebugIds||{},y._sentryDebugIds[u]="0565a200-a1e1-48ed-afc3-642da77ec186",y._sentryDebugIdIdentifier="sentry-dbid-0565a200-a1e1-48ed-afc3-642da77ec186")}catch{}})();const xe={key:1},Se={class:"text-xs text-white select-none scroll-text"},Ve={key:3,class:"w-16 text-justify text-slate-100"},ke={key:4,class:"w-16 text-justify text-slate-100"},Me={class:"flex justify-center w-6"},Fe={class:"flex w-full justify-between items-center mt-4"},Ie={key:1,class:"w-5 h-5 ml-2 rounded-full bg-red"},Ce=Z({__name:"MiniVideoRecorder",props:{miniWidget:{}},setup(y){const{showDialog:u}=ee(),F=te(),b=ae(),n=se(),s=ne(y).miniWidget,a=v(),{namessAvailableAbstractedStreams:V}=oe(n),N=v(),{isOutside:R}=ie(N),D=v(!1),x=v(!1),J=re({interval:100}),c=v(),S=v(!1),O=v(0),o=v(),I=C(()=>o.value),W=()=>{F.videoLibraryVisibility=!0};m(()=>n.streamsCorrespondency,()=>c.value=void 0,{deep:!0}),le(async()=>{await k()}),de(async()=>{Object.keys(s.value.options).length===0&&(s.value.options={internalStreamName:void 0}),a.value=s.value.options.internalStreamName,a.value&&(o.value=n.externalStreamId(a.value))}),m(a,()=>{s.value.options.internalStreamName=a.value,c.value=void 0}),m(()=>n.streamsCorrespondency,t=>{if(!o.value)return;const e=t.find(r=>r.externalId===o.value);e?a.value!==e.name&&(a.value=e.name):(a.value=void 0,o.value=void 0)},{deep:!0}),m(a,t=>{o.value=t?n.externalStreamId(t):void 0,s.value.options.internalStreamName=t,c.value=void 0});const k=async()=>{const e=(await n.videoStorage.keys()).filter(l=>n.isVideoFilename(l)).length,r=Object.keys(n.keysFailedUnprocessedVideos).length;O.value=e+r};function B(t){if(a.value=t,a.value===void 0){u({message:"No stream selected.",variant:"error"});return}if(V.value.includes(a.value))return;const e="The selected stream is not available. Please check its source or select another stream.";throw u({message:e,variant:"error"}),new Error(e)}const K=async()=>{if(h.value){o.value&&n.stopRecording(o.value);return}if(!a.value){b.miniWidgetManagerVars(s.value.hash).configMenuOpen=!0;return}$()},$=()=>{var t;if(!o.value){u({title:"Cannot start recording.",message:"No stream selected.",variant:"error"});return}if(!((t=n.getStreamData(o.value))!=null&&t.connected)){u({title:"Cannot start recording.",message:"Stream is not connected.",variant:"error"});return}B(a.value),n.startRecording(o.value),b.miniWidgetManagerVars(s.value.hash).configMenuOpen=!1},h=C(()=>o.value?n.isRecording(o.value):!1),Q=C(()=>{var A,T,E,P;if(I.value===void 0)return"00:00:00";const t=(A=n.getStreamData(I.value))==null?void 0:A.timeRecordingStart;if(t===void 0)return"00:00:00";const e=ue({start:t,end:J.value}),r=((T=e.hours)==null?void 0:T.toFixed(0).length)===1?`0${e.hours}`:e.hours,l=((E=e.minutes)==null?void 0:E.toFixed(0).length)===1?`0${e.minutes}`:e.minutes,X=((P=e.seconds)==null?void 0:P.toFixed(0).length)===1?`0${e.seconds}`:e.seconds;return`${r}:${l}:${X}`}),Y=async t=>{B(t),c.value=void 0,x.value=!0;let e=0;const r=100,l=3e3;for(;x.value&&e<l;)x.value=c.value===void 0||!c.value.active,await he(r),e+=r;if(x.value){u({message:"Could not load media stream.",variant:"error"});return}s.value.options.internalStreamName=t};let j;return b.isRealMiniWidget(s.value.hash)&&(j=setInterval(()=>{if(s.value.options.internalStreamName===void 0&&!V.value.isEmpty()&&(s.value.options.internalStreamName=V.value[0],a.value=s.value.options.internalStreamName),I.value!==void 0){const t=n.getMediaStream(s.value.options.internalStreamName);ce(t,c.value)||(c.value=t)}},1e3)),ve(()=>clearInterval(j)),m(()=>n.areThereVideosProcessing,t=>{S.value=t,k()}),m(()=>n.keysFailedUnprocessedVideos,()=>k()),m(()=>D.value,async t=>{t===!1&&await k()}),m(h,()=>{if(!h.value){window.onbeforeunload=null;return}window.onbeforeunload=()=>(u({message:`
      You have a video recording ongoing.
      Remember to stop it before closing Cockpit, or the record will be lost.
    `,variant:"warning"}),"I hope the user does not click on the leave button.")}),(t,e)=>{const r=me("FontAwesomeIcon");return d(),f(L,null,[g("div",{ref_key:"recorderWidget",ref:N,class:"flex justify-around px-2 py-1 text-center rounded-lg w-40 h-9 align-center bg-slate-800/60"},[S.value?(d(),f("div",xe,[p(_,{class:"w-6 h-6 animate-spin",color:"white"},{default:w(()=>e[4]||(e[4]=[M("mdi-loading")])),_:1})])):(d(),f("div",{key:0,class:U([{"blob red w-5 opacity-100 rounded-sm":h.value,"opacity-30 bg-red-400":i(R)&&!h.value},"w-6 transition-all duration-500 rounded-full aspect-square bg-red-lighten-1 hover:cursor-pointer opacity-70 hover:opacity-90"]),onClick:e[0]||(e[0]=l=>K())},null,2)),!h.value&&!S.value?(d(),f(L,{key:2},[a.value?(d(),f("div",{key:0,class:"flex flex-col max-w-[50%] scroll-container transition-all border-blur cursor-pointer",onClick:e[1]||(e[1]=l=>i(b).miniWidgetManagerVars(i(s).hash).configMenuOpen=!0)},[g("div",Se,q(a.value),1)])):(d(),z(r,{key:1,icon:"fa-solid fa-video",class:"h-6 text-slate-100"}))],64)):H("",!0),h.value&&!S.value?(d(),f("div",Ve,q(Q.value),1)):S.value?(d(),f("div",ke,e[5]||(e[5]=[g("div",{class:"text-xs text-center text-white select-none flex-nowrap"},"Processing video...",-1)]))):H("",!0),g("div",Me,[p(fe,{vertical:"",class:"h-6 ml-1"}),p(ge,{color:"info",content:O.value,dot:i(R)||D.value,class:"cursor-pointer",onClick:W},{default:w(()=>[p(_,{class:"w-6 h-6 ml-1 text-slate-100",onClick:W},{default:w(()=>e[6]||(e[6]=[M(" mdi-video-box ")])),_:1})]),_:1},8,["content","dot"])])],512),p(be,{modelValue:i(b).miniWidgetManagerVars(i(s).hash).configMenuOpen,"onUpdate:modelValue":e[3]||(e[3]=l=>i(b).miniWidgetManagerVars(i(s).hash).configMenuOpen=l),width:"auto"},{default:w(()=>[g("div",{class:"flex flex-col items-center p-2 pt-1 m-5 rounded-md gap-y-4",style:pe(i(F).globalGlassMenuStyles)},[e[10]||(e[10]=g("p",{class:"text-xl font-semibold m-4"},"Choose a stream to record",-1)),p(ye,{"model-value":a.value,label:"Stream name",items:i(V),"item-title":"name",density:"compact",variant:"outlined","no-data-text":"No streams available.","hide-details":"","return-object":"",theme:"dark",class:"w-[90%]","onUpdate:modelValue":Y},null,8,["model-value","items"]),g("div",Fe,[p(G,{class:"w-auto text-uppercase",variant:"text",onClick:e[2]||(e[2]=l=>i(b).miniWidgetManagerVars(i(s).hash).configMenuOpen=!1)},{default:w(()=>e[7]||(e[7]=[M(" Close ")])),_:1}),p(G,{class:U(["bg-[#FFFFFF11] hover:bg-[#FFFFFF33]",{"opacity-30 pointer-events-none":x.value}]),size:"large",onClick:$},{default:w(()=>[e[9]||(e[9]=g("span",null,"Record",-1)),x.value?(d(),z(_,{key:0,class:"m-2 animate-spin"},{default:w(()=>e[8]||(e[8]=[M("mdi-loading")])),_:1})):(d(),f("div",Ie))]),_:1},8,["class"])])],4)]),_:1},8,["modelValue"])],64)}}}),Re=we(Ce,[["__scopeId","data-v-cc9e6cd8"]]);export{Re as default};
//# sourceMappingURL=MiniVideoRecorder-CLf47Pgo.js.map
