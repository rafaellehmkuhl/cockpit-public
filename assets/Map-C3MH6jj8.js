import{bw as Ie,bx as Oe,by as ze,bz as Z,f as Ne,bA as ye,bB as $e,bC as Pe,c as Fe,aZ as Be,J as Ue,K as Re,a7 as _e,u as Xe,aj as We,r as m,k as O,M as Me,Y as we,L as Ye,bD as r,j as Ge,w as M,o as Ze,bE as h,ad as qe,bF as je,aD as Je,bG as Ke,bH as ke,aA as Qe,y as et,l as I,m as ne,n as P,G as xe,T as Te,I as F,v as se,q as i,aq as V,a5 as q,s as D,O as j,H as B,N as J,V as tt,P as at,Q as ot,R as nt,a4 as st,W as lt,bI as rt,F as it,z as ut,B as ct,E as dt,bJ as le}from"./index-C2Md3HRv.js";function Ee(f,b){if(f==null)throw new TypeError("assign requires that input parameter not be null or undefined");for(var s in b)Object.prototype.hasOwnProperty.call(b,s)&&(f[s]=b[s]);return f}function mt(f){return Ee({},f)}var Ce=1440,ft=2520,re=43200,vt=86400;function pt(f,b,s){var z,N;Ie(2,arguments);var u=Pe(),n=(z=(N=s==null?void 0:s.locale)!==null&&N!==void 0?N:u.locale)!==null&&z!==void 0?z:Oe;if(!n.formatDistance)throw new RangeError("locale must contain formatDistance property");var t=ze(f,b);if(isNaN(t))throw new RangeError("Invalid time value");var l=Ee(mt(s),{addSuffix:!!(s!=null&&s.addSuffix),comparison:t}),v,d;t>0?(v=Z(b),d=Z(f)):(v=Z(f),d=Z(b));var k=Ne(d,v),x=(ye(d)-ye(v))/1e3,c=Math.round((k-x)/60),T;if(c<2)return s!=null&&s.includeSeconds?k<5?n.formatDistance("lessThanXSeconds",5,l):k<10?n.formatDistance("lessThanXSeconds",10,l):k<20?n.formatDistance("lessThanXSeconds",20,l):k<40?n.formatDistance("halfAMinute",0,l):k<60?n.formatDistance("lessThanXMinutes",1,l):n.formatDistance("xMinutes",1,l):c===0?n.formatDistance("lessThanXMinutes",1,l):n.formatDistance("xMinutes",c,l);if(c<45)return n.formatDistance("xMinutes",c,l);if(c<90)return n.formatDistance("aboutXHours",1,l);if(c<Ce){var U=Math.round(c/60);return n.formatDistance("aboutXHours",U,l)}else{if(c<ft)return n.formatDistance("xDays",1,l);if(c<re){var R=Math.round(c/Ce);return n.formatDistance("xDays",R,l)}else if(c<vt)return T=Math.round(c/re),n.formatDistance("aboutXMonths",T,l)}if(T=$e(d,v),T<12){var K=Math.round(c/re);return n.formatDistance("xMonths",K,l)}else{var _=T%12,L=Math.floor(T/12);return _<3?n.formatDistance("aboutXYears",L,l):_<9?n.formatDistance("overXYears",L,l):n.formatDistance("almostXYears",L+1,l)}}function gt(f,b){return Ie(1,arguments),pt(f,Date.now(),b)}const ht=""+new URL("blueboat-marker-DyHmCFOq.png",import.meta.url).href,bt=""+new URL("brov2-marker-CBzp11FX.png",import.meta.url).href,yt=""+new URL("generic-vehicle-marker-SovxT5Tc.png",import.meta.url).href,Mt=["id"],kt=Fe({__name:"Map",props:{widget:{}},setup(f){var be;Be(e=>({"2f3e2e10":Le.value}));const b=f,s=Ue(b).widget,z=Re(),{showDialog:N}=_e(),u=Xe(),n=We();let t;const l=m(n.defaultMapZoom),v=m(n.defaultMapCenter),d=m(),k=O(()=>`map-${s.value.hash}`),x=m(!1);Me.registerUsage(we.latitude),Me.registerUsage(we.longitude),Ye(()=>{Object.keys(s.value.options).length===0&&(s.value.options={showVehiclePath:!0}),p.enableAutoUpdate()});const c=r.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"© OpenStreetMap"}),T=r.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri World Imagery"}),U=r.tileLayer("https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png",{maxZoom:18,attribution:"© OpenSeaMap contributors"}),R=r.tileLayer.wms("https://geoserver.openseamap.org/geoserver/gwc/service/wms",{layers:"gebco2021:gebco_2021",format:"image/png",transparent:!0,version:"1.1.1",attribution:"© GEBCO, OpenSeaMap",tileSize:256,maxZoom:19}),K={OpenStreetMap:c,"Esri World Imagery":T},_={Seamarks:U,"Marine Profile":R},L=m(),ie=Ge(L),ue=r.control.zoom({position:"bottomright"}),ce=r.control.layers(K,_);M(x,()=>{t!==void 0&&(x.value?(t.addControl(ue),t.addControl(ce)):(t.removeControl(ue),t.removeControl(ce)))}),M(ie,()=>{x.value=ie.value}),Ze(async()=>{t=r.map(k.value,{layers:[c,T,U,R],attributionControl:!1}).setView(v.value,l.value),t.removeControl(t.zoomControl),t.on("moveend",()=>{if(t===void 0)return;let{lat:e,lng:a}=t.getCenter();e&&a&&(v.value=[e,a])}),t.on("zoomend",()=>{t!==void 0&&(l.value=(t==null?void 0:t.getZoom())??v.value)}),t.on("click",()=>{t!==void 0&&t.on("click",fe)}),t.on("contextmenu",()=>{pe()}),p.enableAutoUpdate(),window.addEventListener("keydown",ge),g.value?p.goToTarget(h.VEHICLE):p.goToTarget(h.HOME)}),qe(()=>{p.disableAutoUpdate(),window.removeEventListener("keydown",ge),t&&(t.off("click",fe),t.off("contextmenu"))}),M(v,(e,a)=>{var o,y;e.toString()!==a.toString()&&(t==null||t.panTo(e),(y=(o=E.value)==null?void 0:o.getTooltip())==null||y.setContent(`Home: ${e[0].toFixed(6)}, ${e[1].toFixed(6)}`))}),M(l,(e,a)=>{e!==a&&(t==null||t.setZoom(l.value))}),M(b.widget,()=>{t==null||t.invalidateSize()});const X=m(void 0),p=new je(e=>X.value=e,e=>v.value=e);p.setTrackableTarget(h.VEHICLE,()=>g.value),p.setTrackableTarget(h.HOME,()=>d.value);const g=O(()=>u.coordinates.latitude?[u.coordinates.latitude,u.coordinates.longitude]:void 0),Q=O(()=>{var e;return u.attitude.yaw?Je((e=u.attitude)==null?void 0:e.yaw):0}),de=O(()=>{const e=u.lastHeartbeat;return e?`${gt(e??0,{includeSeconds:!0})} ago`:"never"}),{history:Se}=Ke(g);(be=navigator==null?void 0:navigator.geolocation)==null||be.watchPosition(e=>d.value=[e.coords.latitude,e.coords.longitude],e=>console.error(`Failed to get position: (${e.code}) ${e.message}`),{enableHighAccuracy:!1,timeout:5e3,maximumAge:0});let me=!0;M([d,t],async()=>{d.value===v.value||!t||!me||(p.goToTarget(h.HOME),me=!1)});const C=m();M(u.coordinates,()=>{if(!(!t||!g.value)){if(C.value===void 0){let e=yt;u.vehicleType===ke.MAV_TYPE_SURFACE_BOAT?e=ht:u.vehicleType===ke.MAV_TYPE_SUBMARINE&&(e=bt);const a=r.divIcon({className:"vehicle-marker",html:`<img src="${e}" style="width: 64px; height: 64px;">`,iconSize:[64,64],iconAnchor:[32,32]});C.value=r.marker(g.value,{icon:a});const o=r.tooltip({content:"No data available",className:"waypoint-tooltip",offset:[40,0]});C.value.bindTooltip(o),t.addLayer(C.value)}C.value.setLatLng(g.value)}}),M(g,(e,a)=>{X.value===h.VEHICLE||a!==void 0||p.follow(h.VEHICLE)}),M([g,Q,de,()=>u.isArmed],()=>{var a,o,y,w,H;if(C.value===void 0)return;(w=C.value.getTooltip())==null||w.setContent(`
    <p>Coordinates: ${(a=g.value)==null?void 0:a[0].toFixed(6)}, ${(o=g.value)==null?void 0:o[1].toFixed(6)}</p>
    <p>Velocity: ${((y=u.velocity.ground)==null?void 0:y.toFixed(2))??"N/A"} m/s</p>
    <p>Heading: ${Q.value.toFixed(2)}°</p>
    <p>${u.isArmed?"Armed":"Disarmed"}</p>
    <p>Last seen: ${de.value}</p>
  `);const e=(H=C.value.getElement())==null?void 0:H.querySelector("img");e&&(e.style.transform=`rotate(${Q.value}deg)`)});const E=m();M(d,()=>{if(t===void 0)return;const e=d.value;if(e!==void 0){if(E.value===void 0){E.value=r.marker(e);const a=r.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16],html:"H"});E.value.setIcon(a);const o=r.tooltip({content:"No data available",className:"waypoint-tooltip"});E.value.bindTooltip(o),t.addLayer(E.value)}E.value.setLatLng(d.value)}});const ee=m();M(n.currentPlanningWaypoints,e=>{if(t!==void 0){if(ee.value===void 0){const a=e.map(o=>o.coordinates);ee.value=r.polyline(a,{color:"#358AC3"}).addTo(t)}ee.value.setLatLngs(e.map(a=>a.coordinates)),e.forEach((a,o)=>{const y=r.marker(a.coordinates),w=r.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16],html:`${o}`});y.setIcon(w),t==null||t.addLayer(y)})}});const te=m();M(Se,e=>{if(t===void 0||e===void 0)return;te.value===void 0&&(te.value=r.polyline([],{color:"#ffff00"}).addTo(t));const a=e.filter(o=>o.snapshot!==void 0).map(o=>o.snapshot);te.value.setLatLngs(a)});const W=m(!1),A=m(null),Y=Qe({top:"0px",left:"0px"}),S=m(),fe=e=>{var a,o,y;if(S.value!==void 0&&t!==void 0&&((a=S.value)==null||a.removeFrom(t)),((o=e==null?void 0:e.latlng)==null?void 0:o.lat)!=null&&((y=e==null?void 0:e.latlng)==null?void 0:y.lng)!=null){A.value=[e.latlng.lat,e.latlng.lng],W.value=!0;const w=t==null?void 0:t.getContainer();if(w){const{x:H,y:oe}=w.getBoundingClientRect();Y.left=`${e.originalEvent.clientX-H}px`,Y.top=`${e.originalEvent.clientY-oe}px`}}else console.error("Invalid event structure:",e);if(t!==void 0){S.value=r.marker(A.value);const w=r.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16]});S.value.setIcon(w),t.addLayer(S.value)}},ve=e=>{switch(e){case"goto":if(A.value){const H=u.coordinates.altitude??0,oe=A.value[0],Ae=A.value[1];ut(async()=>{try{await u.goTo(0,0,0,0,oe,Ae,H)}catch(He){le({message:He,variant:"error"})}},{command:"GoTo"},ct(dt.GOTO))}break;case"set-default-map-position":n.setDefaultMapPosition(v.value,l.value);break;default:console.warn("Unknown menu option selected:",e)}W.value=!1},pe=()=>{W.value=!1,A.value=null,t!==void 0&&S.value!==void 0&&t.removeLayer(S.value)},ge=e=>{e.key==="Escape"&&pe()},G=m(!1),ae=m(0),Ve=async()=>{for(G.value=!0,ae.value=0;n.currentPlanningWaypoints.length>0;)n.currentPlanningWaypoints.pop();const e=async a=>{ae.value=a};try{(await u.fetchMission(e)).forEach(o=>{n.currentPlanningWaypoints.push(o)}),le({variant:"success",message:"Mission download succeed!",duration:3e3})}catch(a){N({variant:"error",title:"Mission download failed",message:a,timer:5e3})}finally{G.value=!1}},De=async()=>{try{await u.startMission()}catch{le({message:"Failed to start mission.",variant:"error"})}},$=et(),Le=O(()=>`${Math.max(-$.widgetClearanceForVisibleArea(s.value).bottom,0)}px`),he=O(()=>`${Math.max(-$.widgetClearanceForVisibleArea(s.value).top,0)}px`);return(e,a)=>(I(),ne(it,null,[P("div",{ref_key:"mapBase",ref:L,class:se(["page-base",i($).editingMode?"pointer-events-none":"pointer-events-auto"])},[P("div",{id:k.value,class:"map"},[x.value?xe((I(),F(q,{key:0,class:se(["absolute left-0 m-3 bottom-button bg-slate-50",d.value?"":"active-events-on-disabled"]),color:X.value==i(h).HOME?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-home-map-marker",size:"x-small",disabled:!d.value,onClick:a[0]||(a[0]=V(o=>i(p).goToTarget(i(h).HOME,!0),["stop"])),onDblclick:a[1]||(a[1]=V(o=>i(p).follow(i(h).HOME),["stop"]))},null,8,["class","color","disabled"])),[[Te,d.value?"Center map on home position.":"Home position is currently undefined."]]):D("",!0),x.value?xe((I(),F(q,{key:1,class:se(["absolute m-3 bottom-button left-10 bg-slate-50",g.value?"":"active-events-on-disabled"]),color:X.value==i(h).VEHICLE?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-airplane-marker",size:"x-small",disabled:!g.value,onClick:a[2]||(a[2]=V(o=>i(p).goToTarget(i(h).VEHICLE,!0),["stop"])),onDblclick:a[3]||(a[3]=V(o=>i(p).follow(i(h).VEHICLE),["stop"]))},null,8,["class","color","disabled"])),[[Te,g.value?"Center map on vehicle position.":"Vehicle position is currently undefined."]]):D("",!0),x.value?(I(),F(q,{key:2,class:"absolute m-3 bottom-button left-20 bg-slate-50",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-download",size:"x-small",onClick:V(Ve,["stop"])})):D("",!0),x.value?(I(),F(q,{key:3,class:"absolute mb-3 ml-1 bottom-button left-32 bg-slate-50",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-play",size:"x-small",onClick:V(De,["stop"])})):D("",!0)],8,Mt)],2),W.value?(I(),ne("div",{key:0,class:"context-menu",style:j({top:Y.top,left:Y.left})},[P("ul",{onClick:a[6]||(a[6]=V(()=>{},["stop"]))},[P("li",{onClick:a[4]||(a[4]=o=>ve("goto"))},"GoTo"),P("li",{onClick:a[5]||(a[5]=o=>ve("set-default-map-position"))},"Set default map position")])],4)):D("",!0),B(lt,{modelValue:i($).widgetManagerVars(i(s).hash).configMenuOpen,"onUpdate:modelValue":a[8]||(a[8]=o=>i($).widgetManagerVars(i(s).hash).configMenuOpen=o),width:"auto"},{default:J(()=>[B(tt,{class:"pa-2",style:j(i(z).globalGlassMenuStyles)},{default:J(()=>[B(at,{class:"text-center"},{default:J(()=>a[9]||(a[9]=[ot("Map widget settings")])),_:1}),B(nt,null,{default:J(()=>[B(st,{modelValue:i(s).options.showVehiclePath,"onUpdate:modelValue":a[7]||(a[7]=o=>i(s).options.showVehiclePath=o),class:"my-1",label:"Show vehicle path",color:i(s).options.showVehiclePath?"white":void 0,"hide-details":""},null,8,["modelValue","color"])]),_:1})]),_:1},8,["style"])]),_:1},8,["modelValue"]),G.value?(I(),F(rt,{key:1,"model-value":ae.value,height:"10",absolute:"",bottom:"",color:"white",style:j(`top: ${he.value}`)},null,8,["model-value","style"])):D("",!0),G.value?(I(),ne("p",{key:2,style:j({top:he.value}),class:"absolute left-[7px] mt-4 flex text-md font-bold text-white z-30 drop-shadow-md"}," Loading mission... ",4)):D("",!0)],64))}});export{kt as default};
